@using Storingsdienst.Client.Models

<MudCard Class="verification-card">
    <MudCardHeader>
        <CardHeaderContent>
            <MudStack Row="true" AlignItems="AlignItems.Center">
                <MudIcon Icon="@Icons.Material.Filled.EventAvailable" Class="mr-2" />
                <MudText Typo="Typo.h6">Verify Paystub Data</MudText>
            </MudStack>
        </CardHeaderContent>
        <CardHeaderActions>
            @if (AllowRemove)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Error" Size="Size.Small"
                               OnClick="OnRemove" />
            }
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        @if (MonthlyResults != null && MonthlyResults.Any())
        {
            <MudGrid Spacing="3">
                @* Month Selection *@
                <MudItem xs="12">
                    <MudSelect T="string" Label="Select Month to Verify" @bind-Value="SelectedMonthKey"
                               Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="string" Value="@string.Empty">-- Select a month --</MudSelectItem>
                        @foreach (var month in MonthlyResults)
                        {
                            var key = $"{month.Year}-{month.Month:D2}";
                            <MudSelectItem T="string" Value="@key">@month.MonthName @month.Year</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @if (!string.IsNullOrEmpty(SelectedMonthKey) && SelectedMonth != null)
                {
                    @* Calculated Days from Calendar *@
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Info" Dense="true">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">
                                <strong>Calendar Data for @SelectedMonth.MonthName @SelectedMonth.Year:</strong>
                            </MudText>
                            <MudList T="string" Dense="true">
                                <MudListItem>Weekdays: <strong>@SelectedMonth.WeekdayCount</strong></MudListItem>
                                <MudListItem>Saturdays: <strong>@SelectedMonth.SaturdayCount</strong></MudListItem>
                                <MudListItem>Sundays: <strong>@SelectedMonth.SundayCount</strong></MudListItem>
                                <MudListItem>Holidays: <strong>@SelectedMonth.HolidayCount</strong></MudListItem>
                            </MudList>
                        </MudAlert>
                    </MudItem>

                    @* Paystub Input Fields *@
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle1" Class="mb-2">Enter Paystub Data:</MudText>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudNumericField T="int" Label="Weekdays Paid" @bind-Value="PaystubWeekdays"
                                         Variant="Variant.Outlined" Min="0" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudNumericField T="int" Label="Saturdays Paid" @bind-Value="PaystubSaturdays"
                                         Variant="Variant.Outlined" Min="0" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudNumericField T="int" Label="Sundays Paid" @bind-Value="PaystubSundays"
                                         Variant="Variant.Outlined" Min="0" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudNumericField T="int" Label="Holidays Paid" @bind-Value="PaystubHolidays"
                                         Variant="Variant.Outlined" Min="0" />
                    </MudItem>

                    @* Verify Button *@
                    <MudItem xs="12">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.CheckCircle" OnClick="VerifyData">
                            Verify Data
                        </MudButton>
                    </MudItem>

                    @* Verification Results *@
                    @if (IsVerified)
                    {
                        <MudItem xs="12">
                            @if (AllMatch)
                            {
                                <MudAlert Severity="Severity.Success" Variant="Variant.Filled">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" />
                                        <div>
                                            <MudText Typo="Typo.subtitle1"><strong>All data matches!</strong></MudText>
                                            <MudText Typo="Typo.body2">Your paystub data matches the calendar entries.</MudText>
                                        </div>
                                    </MudStack>
                                </MudAlert>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Warning" Variant="Variant.Filled">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Large" />
                                        <MudText Typo="Typo.subtitle1"><strong>Discrepancies found:</strong></MudText>
                                    </MudStack>
                                    <MudList T="string" Dense="true">
                                        @if (WeekdaysMatch)
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                                                Weekdays match (@SelectedMonth.WeekdayCount)
                                            </MudListItem>
                                        }
                                        else
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.Close" IconColor="Color.Error">
                                                Weekdays: Calendar shows @SelectedMonth.WeekdayCount, Paystub shows @PaystubWeekdays (Difference: @Math.Abs(SelectedMonth.WeekdayCount - PaystubWeekdays))
                                            </MudListItem>
                                        }

                                        @if (SaturdaysMatch)
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                                                Saturdays match (@SelectedMonth.SaturdayCount)
                                            </MudListItem>
                                        }
                                        else
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.Close" IconColor="Color.Error">
                                                Saturdays: Calendar shows @SelectedMonth.SaturdayCount, Paystub shows @PaystubSaturdays (Difference: @Math.Abs(SelectedMonth.SaturdayCount - PaystubSaturdays))
                                            </MudListItem>
                                        }

                                        @if (SundaysMatch)
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                                                Sundays match (@SelectedMonth.SundayCount)
                                            </MudListItem>
                                        }
                                        else
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.Close" IconColor="Color.Error">
                                                Sundays: Calendar shows @SelectedMonth.SundayCount, Paystub shows @PaystubSundays (Difference: @Math.Abs(SelectedMonth.SundayCount - PaystubSundays))
                                            </MudListItem>
                                        }

                                        @if (HolidaysMatch)
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                                                Holidays match (@SelectedMonth.HolidayCount)
                                            </MudListItem>
                                        }
                                        else
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.Close" IconColor="Color.Error">
                                                Holidays: Calendar shows @SelectedMonth.HolidayCount, Paystub shows @PaystubHolidays (Difference: @Math.Abs(SelectedMonth.HolidayCount - PaystubHolidays))
                                            </MudListItem>
                                        }
                                    </MudList>
                                </MudAlert>
                            }
                        </MudItem>
                    }
                }
            </MudGrid>
        }
        else
        {
            <MudText Typo="Typo.body2" Class="mud-text-secondary">No calendar data available. Please process a file first.</MudText>
        }
    </MudCardContent>
</MudCard>

@code {
    [Parameter]
    public List<MonthlyBreakdown>? MonthlyResults { get; set; }

    [Parameter]
    public EventCallback OnRemoveClicked { get; set; }

    [Parameter]
    public bool AllowRemove { get; set; } = false;

    [Parameter]
    public string Id { get; set; } = Guid.NewGuid().ToString();

    private string SelectedMonthKey { get; set; } = string.Empty;
    private MonthlyBreakdown? SelectedMonth { get; set; }

    private int PaystubWeekdays { get; set; }
    private int PaystubSaturdays { get; set; }
    private int PaystubSundays { get; set; }
    private int PaystubHolidays { get; set; }

    private bool IsVerified { get; set; }
    private bool AllMatch { get; set; }
    private bool WeekdaysMatch { get; set; }
    private bool SaturdaysMatch { get; set; }
    private bool SundaysMatch { get; set; }
    private bool HolidaysMatch { get; set; }

    protected override void OnParametersSet()
    {
        UpdateSelectedMonth();
    }

    private void UpdateSelectedMonth()
    {
        if (string.IsNullOrEmpty(SelectedMonthKey) || MonthlyResults == null)
        {
            SelectedMonth = null;
            IsVerified = false;
            return;
        }

        var parts = SelectedMonthKey.Split('-');
        if (parts.Length == 2 && int.TryParse(parts[0], out var year) && int.TryParse(parts[1], out var month))
        {
            SelectedMonth = MonthlyResults.FirstOrDefault(m => m.Year == year && m.Month == month);
            IsVerified = false;
        }
    }

    private void VerifyData()
    {
        if (SelectedMonth == null) return;

        WeekdaysMatch = SelectedMonth.WeekdayCount == PaystubWeekdays;
        SaturdaysMatch = SelectedMonth.SaturdayCount == PaystubSaturdays;
        SundaysMatch = SelectedMonth.SundayCount == PaystubSundays;
        HolidaysMatch = SelectedMonth.HolidayCount == PaystubHolidays;

        AllMatch = WeekdaysMatch && SaturdaysMatch && SundaysMatch && HolidaysMatch;
        IsVerified = true;
    }

    private async Task OnRemove()
    {
        await OnRemoveClicked.InvokeAsync();
    }
}
