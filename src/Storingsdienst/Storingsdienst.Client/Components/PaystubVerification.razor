@using Storingsdienst.Client.Models
@inject ILocalizationService L
@implements IDisposable

<MudCard Class="verification-card">
    <MudCardHeader>
        <CardHeaderContent>
            <MudStack Row="true" AlignItems="AlignItems.Center">
                <MudIcon Icon="@Icons.Material.Filled.EventAvailable" Class="mr-2" />
                <MudText Typo="Typo.h6">@L["VerifyPaystubData"]</MudText>
            </MudStack>
        </CardHeaderContent>
        <CardHeaderActions>
            @if (AllowRemove)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Error" Size="Size.Small"
                               OnClick="OnRemove" />
            }
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        @if (MonthlyResults != null && MonthlyResults.Any())
        {
            <MudGrid Spacing="3">
                @* Month Selection *@
                <MudItem xs="12">
                    <MudSelect T="string" Label="@L["SelectMonthToVerify"]" @bind-Value="SelectedMonthKey"
                               Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="string" Value="@string.Empty">@L["SelectMonthPlaceholder"]</MudSelectItem>
                        @foreach (var month in MonthlyResults)
                        {
                            var key = $"{month.Year}-{month.Month:D2}";
                            <MudSelectItem T="string" Value="@key">@month.MonthName @month.Year</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @if (!string.IsNullOrEmpty(SelectedMonthKey) && SelectedMonth != null)
                {
                    @* Calculated Days from Calendar *@
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Info" Dense="true">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">
                                <strong>@string.Format(L["CalendarDataFor"], SelectedMonth.MonthName, SelectedMonth.Year)</strong>
                            </MudText>
                            <MudList T="string" Dense="true">
                                <MudListItem>@L["Weekdays"]: <strong>@SelectedMonth.WeekdayCount</strong></MudListItem>
                                <MudListItem>@L["Saturdays"]: <strong>@SelectedMonth.SaturdayCount</strong></MudListItem>
                                <MudListItem>@L["Sundays"]: <strong>@SelectedMonth.SundayCount</strong></MudListItem>
                                <MudListItem>@L["Holidays"]: <strong>@SelectedMonth.HolidayCount</strong></MudListItem>
                            </MudList>
                        </MudAlert>
                    </MudItem>

                    @* Paystub Input Fields *@
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle1" Class="mb-2">@L["EnterPaystubData"]</MudText>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudNumericField T="int" Label="@L["WeekdaysPaid"]" @bind-Value="PaystubWeekdays"
                                         Variant="Variant.Outlined" Min="0" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudNumericField T="int" Label="@L["SaturdaysPaid"]" @bind-Value="PaystubSaturdays"
                                         Variant="Variant.Outlined" Min="0" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudNumericField T="int" Label="@L["SundaysPaid"]" @bind-Value="PaystubSundays"
                                         Variant="Variant.Outlined" Min="0" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudNumericField T="int" Label="@L["HolidaysPaid"]" @bind-Value="PaystubHolidays"
                                         Variant="Variant.Outlined" Min="0" />
                    </MudItem>

                    @* Verify Button *@
                    <MudItem xs="12">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.CheckCircle" OnClick="VerifyData">
                            @L["VerifyData"]
                        </MudButton>
                    </MudItem>

                    @* Verification Results *@
                    @if (IsVerified)
                    {
                        <MudItem xs="12">
                            @if (AllMatch)
                            {
                                <MudAlert Severity="Severity.Success" Variant="Variant.Filled">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" />
                                        <div>
                                            <MudText Typo="Typo.subtitle1"><strong>@L["AllDataMatches"]</strong></MudText>
                                            <MudText Typo="Typo.body2">@L["PaystubDataMatchesCalendar"]</MudText>
                                        </div>
                                    </MudStack>
                                </MudAlert>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Warning" Variant="Variant.Filled">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Large" />
                                        <MudText Typo="Typo.subtitle1"><strong>@L["DiscrepanciesFound"]</strong></MudText>
                                    </MudStack>
                                    <MudList T="string" Dense="true">
                                        @if (WeekdaysMatch)
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                                                @string.Format(L["WeekdaysMatch"], SelectedMonth.WeekdayCount)
                                            </MudListItem>
                                        }
                                        else
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.Close" IconColor="Color.Error">
                                                @string.Format(L["WeekdaysDiscrepancy"], SelectedMonth.WeekdayCount, PaystubWeekdays, Math.Abs(SelectedMonth.WeekdayCount - PaystubWeekdays))
                                            </MudListItem>
                                        }

                                        @if (SaturdaysMatch)
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                                                @string.Format(L["SaturdaysMatch"], SelectedMonth.SaturdayCount)
                                            </MudListItem>
                                        }
                                        else
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.Close" IconColor="Color.Error">
                                                @string.Format(L["SaturdaysDiscrepancy"], SelectedMonth.SaturdayCount, PaystubSaturdays, Math.Abs(SelectedMonth.SaturdayCount - PaystubSaturdays))
                                            </MudListItem>
                                        }

                                        @if (SundaysMatch)
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                                                @string.Format(L["SundaysMatch"], SelectedMonth.SundayCount)
                                            </MudListItem>
                                        }
                                        else
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.Close" IconColor="Color.Error">
                                                @string.Format(L["SundaysDiscrepancy"], SelectedMonth.SundayCount, PaystubSundays, Math.Abs(SelectedMonth.SundayCount - PaystubSundays))
                                            </MudListItem>
                                        }

                                        @if (HolidaysMatch)
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                                                @string.Format(L["HolidaysMatch"], SelectedMonth.HolidayCount)
                                            </MudListItem>
                                        }
                                        else
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.Close" IconColor="Color.Error">
                                                @string.Format(L["HolidaysDiscrepancy"], SelectedMonth.HolidayCount, PaystubHolidays, Math.Abs(SelectedMonth.HolidayCount - PaystubHolidays))
                                            </MudListItem>
                                        }
                                    </MudList>
                                </MudAlert>
                            }
                        </MudItem>
                    }
                }
            </MudGrid>
        }
        else
        {
            <MudText Typo="Typo.body2" Class="mud-text-secondary">@L["NoCalendarDataAvailable"]</MudText>
        }
    </MudCardContent>
</MudCard>

@code {
    [Parameter]
    public List<MonthlyBreakdown>? MonthlyResults { get; set; }

    [Parameter]
    public EventCallback OnRemoveClicked { get; set; }

    [Parameter]
    public bool AllowRemove { get; set; } = false;

    [Parameter]
    public string Id { get; set; } = Guid.NewGuid().ToString();

    private string SelectedMonthKey { get; set; } = string.Empty;
    private MonthlyBreakdown? SelectedMonth { get; set; }

    private int PaystubWeekdays { get; set; }
    private int PaystubSaturdays { get; set; }
    private int PaystubSundays { get; set; }
    private int PaystubHolidays { get; set; }

    private bool IsVerified { get; set; }
    private bool AllMatch { get; set; }
    private bool WeekdaysMatch { get; set; }
    private bool SaturdaysMatch { get; set; }
    private bool SundaysMatch { get; set; }
    private bool HolidaysMatch { get; set; }

    protected override void OnInitialized()
    {
        L.OnLanguageChanged += OnLanguageChanged;
    }

    private void OnLanguageChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        L.OnLanguageChanged -= OnLanguageChanged;
    }

    protected override void OnParametersSet()
    {
        // Auto-select the first month if none is selected and data is available
        if (string.IsNullOrEmpty(SelectedMonthKey) && MonthlyResults != null && MonthlyResults.Any())
        {
            var firstMonth = MonthlyResults.First();
            SelectedMonthKey = $"{firstMonth.Year}-{firstMonth.Month:D2}";
        }

        UpdateSelectedMonth();
    }

    private void UpdateSelectedMonth()
    {
        if (string.IsNullOrEmpty(SelectedMonthKey) || MonthlyResults == null)
        {
            SelectedMonth = null;
            IsVerified = false;
            return;
        }

        var parts = SelectedMonthKey.Split('-');
        if (parts.Length == 2 && int.TryParse(parts[0], out var year) && int.TryParse(parts[1], out var month))
        {
            SelectedMonth = MonthlyResults.FirstOrDefault(m => m.Year == year && m.Month == month);
            IsVerified = false;
        }
    }

    private void VerifyData()
    {
        if (SelectedMonth == null) return;

        WeekdaysMatch = SelectedMonth.WeekdayCount == PaystubWeekdays;
        SaturdaysMatch = SelectedMonth.SaturdayCount == PaystubSaturdays;
        SundaysMatch = SelectedMonth.SundayCount == PaystubSundays;
        HolidaysMatch = SelectedMonth.HolidayCount == PaystubHolidays;

        AllMatch = WeekdaysMatch && SaturdaysMatch && SundaysMatch && HolidaysMatch;
        IsVerified = true;
    }

    private async Task OnRemove()
    {
        await OnRemoveClicked.InvokeAsync();
    }
}
