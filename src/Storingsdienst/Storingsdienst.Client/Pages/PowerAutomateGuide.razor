@page "/guide/power-automate"
@inject IJSRuntime JSRuntime
@inject ILocalizationService L
@implements IDisposable

<PageTitle>@L["PowerAutomateSetupGuide"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudIcon Icon="@Icons.Custom.Brands.Microsoft" Size="Size.Large" />
        <MudText Typo="Typo.h4">@L["PowerAutomateSetupGuide"]</MudText>
    </MudStack>
    <MudText Typo="Typo.subtitle1" Class="mud-text-secondary mb-4">
        @L["ExportM365CalendarToJson"]
    </MudText>

    <MudProgressLinear Color="Color.Primary" Value="@GetProgressPercentage()" Class="mb-2" />
    <MudText Typo="Typo.body2" Class="mud-text-secondary mb-4">
        @string.Format(L["StepsCompleted"], _completedSteps.Count(s => s))
    </MudText>

    <MudTimeline TimelinePosition="TimelinePosition.Start">
        @* Step 1: Create New Power Automate Flow *@
        <MudTimelineItem Color="@GetStepColor(0)" Size="Size.Medium">
            <ItemDot>
                <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" />
            </ItemDot>
            <ItemContent>
                <MudCard Elevation="1" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.h6">@L["GuideStep1Title"]</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Setup"] - ~2 @L["Minutes"]</MudText>
                                </div>
                                <MudCheckBox T="bool" @bind-Value="_completedSteps[0]" @bind-Value:after="SaveProgressToStorage"
                                             Color="Color.Success" Label="@L["Complete"]" />
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep1_GoTo"] <MudLink Href="https://make.powerautomate.com" Target="_blank">make.powerautomate.com</MudLink>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep1_ClickCreate"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep1_EnterName"] <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@L["GuideStep1_FlowName"]</MudChip>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep1_SelectTrigger"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep1_ClickCreateBtn"]
                            </MudListItem>
                        </MudList>
                        <MudAlert Severity="Severity.Info" Class="mt-3" Dense="true">
                            <strong>@L["GuideStep1_Tip"]</strong>
                        </MudAlert>
                    </MudCardContent>
                </MudCard>
            </ItemContent>
        </MudTimelineItem>

        @* Step 2: Add Input Parameters *@
        <MudTimelineItem Color="@GetStepColor(1)" Size="Size.Medium">
            <ItemDot>
                <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Small" />
            </ItemDot>
            <ItemContent>
                <MudCard Elevation="1" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.h6">@L["GuideStep2Title"]</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Setup"] - ~1 @L["Minute"]</MudText>
                                </div>
                                <MudCheckBox T="bool" @bind-Value="_completedSteps[1]" @bind-Value:after="SaveProgressToStorage"
                                             Color="Color.Success" Label="@L["Complete"]" />
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep2_AddInput"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep2_SelectText"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep2_InputName"] <code>@L["GuideStep2_SubjectFilter"]</code>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep2_MarkRequired"]
                            </MudListItem>
                        </MudList>
                    </MudCardContent>
                </MudCard>
            </ItemContent>
        </MudTimelineItem>

        @* Step 3: List Calendar Events *@
        <MudTimelineItem Color="@GetStepColor(2)" Size="Size.Medium">
            <ItemDot>
                <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Small" />
            </ItemDot>
            <ItemContent>
                <MudCard Elevation="1" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.h6">@L["GuideStep3Title"]</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Configure"] - ~2 @L["Minutes"]</MudText>
                                </div>
                                <MudCheckBox T="bool" @bind-Value="_completedSteps[2]" @bind-Value:after="SaveProgressToStorage"
                                             Color="Color.Success" Label="@L["Complete"]" />
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep3_NewStep"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep3_SearchOutlook"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep3_ChooseAction"]
                            </MudListItem>
                        </MudList>

                        <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2">@L["GuideStep3_ConfigureParams"]</MudText>
                        <MudPaper Class="pa-3" Elevation="0" Style="background: var(--mud-palette-background-gray);">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.body2"><strong>@L["GuideStep3_CalendarId"]</strong> <code>Calendar</code></MudText>
                                <MudText Typo="Typo.body2"><strong>@L["GuideStep3_StartTime"]</strong> <code>addDays(utcNow(), -365)</code></MudText>
                                <MudText Typo="Typo.body2"><strong>@L["GuideStep3_EndTime"]</strong> <code>utcNow()</code></MudText>
                                <MudText Typo="Typo.body2"><strong>@L["GuideStep3_TimeZone"]</strong> <code>UTC</code></MudText>
                                <MudText Typo="Typo.body2"><strong>@L["GuideStep3_TopCount"]</strong> <code>1000</code></MudText>
                            </MudStack>
                        </MudPaper>
                    </MudCardContent>
                </MudCard>
            </ItemContent>
        </MudTimelineItem>

        @* Step 4: Filter Events by Subject *@
        <MudTimelineItem Color="@GetStepColor(3)" Size="Size.Medium">
            <ItemDot>
                <MudIcon Icon="@Icons.Material.Filled.FilterAlt" Size="Size.Small" />
            </ItemDot>
            <ItemContent>
                <MudCard Elevation="1" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.h6">@L["GuideStep4Title"]</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Configure"] - ~1 @L["Minute"]</MudText>
                                </div>
                                <MudCheckBox T="bool" @bind-Value="_completedSteps[3]" @bind-Value:after="SaveProgressToStorage"
                                             Color="Color.Success" Label="@L["Complete"]" />
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep3_NewStep"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep4_SearchData"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep4_ChooseFilter"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep4_FromField"]
                            </MudListItem>
                        </MudList>

                        <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2">@L["GuideStep4_ConfigureCondition"]</MudText>
                        <MudPaper Class="pa-3" Elevation="0" Style="background: var(--mud-palette-background-gray);">
                            <MudText Typo="Typo.body2" Class="mb-2">@L["GuideStep4_AdvancedMode"]</MudText>
                            <code>@@contains(item()?['subject'], triggerBody()['text'])</code>
                        </MudPaper>
                    </MudCardContent>
                </MudCard>
            </ItemContent>
        </MudTimelineItem>

        @* Step 5: Transform to Required JSON Format *@
        <MudTimelineItem Color="@GetStepColor(4)" Size="Size.Medium">
            <ItemDot>
                <MudIcon Icon="@Icons.Material.Filled.Transform" Size="Size.Small" />
            </ItemDot>
            <ItemContent>
                <MudCard Elevation="1" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.h6">@L["GuideStep5Title"]</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Configure"] - ~3 @L["Minutes"]</MudText>
                                </div>
                                <MudCheckBox T="bool" @bind-Value="_completedSteps[4]" @bind-Value:after="SaveProgressToStorage"
                                             Color="Color.Success" Label="@L["Complete"]" />
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep3_NewStep"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep5_SelectAction"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep5_FromOutput"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep5_ClickMap"]
                            </MudListItem>
                        </MudList>

                        <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2">@L["GuideStep5_FieldMappings"]</MudText>
                        <MudPaper Class="pa-3" Elevation="0" Style="background: var(--mud-palette-background-gray);">
                            <MudStack Spacing="2">
                                <MudText Typo="Typo.body2"><strong>subject:</strong> <code>item()?['subject']</code></MudText>
                                <div>
                                    <MudText Typo="Typo.body2"><strong>start:</strong> @L["GuideStep5_SwitchToArray"]</MudText>
                                    <pre style="font-size: 0.85rem; margin-top: 4px;">{ "dateTime": "@@{item()?['start']?['dateTime']}", "timeZone": "@@{item()?['start']?['timeZone']}" }</pre>
                                </div>
                                <div>
                                    <MudText Typo="Typo.body2"><strong>end:</strong> @L["GuideStep5_SwitchToArray"]</MudText>
                                    <pre style="font-size: 0.85rem; margin-top: 4px;">{ "dateTime": "@@{item()?['end']?['dateTime']}", "timeZone": "@@{item()?['end']?['timeZone']}" }</pre>
                                </div>
                                <MudText Typo="Typo.body2"><strong>isAllDay:</strong> <code>item()?['isAllDay']</code></MudText>
                            </MudStack>
                        </MudPaper>
                    </MudCardContent>
                </MudCard>
            </ItemContent>
        </MudTimelineItem>

        @* Step 6: Create JSON Wrapper *@
        <MudTimelineItem Color="@GetStepColor(5)" Size="Size.Medium">
            <ItemDot>
                <MudIcon Icon="@Icons.Material.Filled.Code" Size="Size.Small" />
            </ItemDot>
            <ItemContent>
                <MudCard Elevation="1" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.h6">@L["GuideStep6Title"]</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Configure"] - ~1 @L["Minute"]</MudText>
                                </div>
                                <MudCheckBox T="bool" @bind-Value="_completedSteps[5]" @bind-Value:after="SaveProgressToStorage"
                                             Color="Color.Success" Label="@L["Complete"]" />
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep3_NewStep"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep6_SelectCompose"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep6_InputsField"]
                            </MudListItem>
                        </MudList>

                        <MudPaper Class="pa-3 mt-2" Elevation="0" Style="background: var(--mud-palette-background-gray);">
                            <pre style="font-size: 0.85rem; margin: 0;">{
  "events": @@{body('Select')},
  "exportDate": "@@{utcNow()}",
  "subjectFilter": "@@{triggerBody()['text']}"
}</pre>
                        </MudPaper>
                    </MudCardContent>
                </MudCard>
            </ItemContent>
        </MudTimelineItem>

        @* Step 7: Save to OneDrive *@
        <MudTimelineItem Color="@GetStepColor(6)" Size="Size.Medium">
            <ItemDot>
                <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Size="Size.Small" />
            </ItemDot>
            <ItemContent>
                <MudCard Elevation="1" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.h6">@L["GuideStep7Title"]</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Output"] - ~2 @L["Minutes"]</MudText>
                                </div>
                                <MudCheckBox T="bool" @bind-Value="_completedSteps[6]" @bind-Value:after="SaveProgressToStorage"
                                             Color="Color.Success" Label="@L["Complete"]" />
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep3_NewStep"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep7_SearchOneDrive"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep7_ChooseCreate"]
                            </MudListItem>
                        </MudList>

                        <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2">@L["GuideStep7_ConfigureFile"]</MudText>
                        <MudPaper Class="pa-3" Elevation="0" Style="background: var(--mud-palette-background-gray);">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.body2"><strong>@L["GuideStep7_FolderPath"]</strong> <code>/Documents/CalendarExports</code></MudText>
                                <MudText Typo="Typo.body2"><strong>@L["GuideStep7_FileName"]</strong> <code>calendar_export_@@{formatDateTime(utcNow(), 'yyyyMMdd_HHmmss')}.json</code></MudText>
                                <MudText Typo="Typo.body2"><strong>@L["GuideStep7_FileContent"]</strong></MudText>
                            </MudStack>
                        </MudPaper>

                        <MudAlert Severity="Severity.Warning" Class="mt-3" Dense="true">
                            <strong>@L["GuideStep7_CreateFolder"]</strong>
                        </MudAlert>

                        <MudAlert Severity="Severity.Info" Class="mt-2" Dense="true">
                            <strong>@L["GuideStep7_SharePointAlt"]</strong>
                        </MudAlert>
                    </MudCardContent>
                </MudCard>
            </ItemContent>
        </MudTimelineItem>

        @* Step 8: Test & Export Your Flow *@
        <MudTimelineItem Color="@GetStepColor(7)" Size="Size.Medium">
            <ItemDot>
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" />
            </ItemDot>
            <ItemContent>
                <MudCard Elevation="1" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.h6">@L["GuideStep8Title"]</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Test"] - ~2 @L["Minutes"]</MudText>
                                </div>
                                <MudCheckBox T="bool" @bind-Value="_completedSteps[7]" @bind-Value:after="SaveProgressToStorage"
                                             Color="Color.Success" Label="@L["Complete"]" />
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText Typo="Typo.subtitle2" Class="mb-2">@L["GuideStep8_RunningFlow"]</MudText>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep1_GoTo"] <MudLink Href="https://make.powerautomate.com" Target="_blank">make.powerautomate.com</MudLink>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep8_ClickMyFlows"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep8_FindFlow"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep8_EnterSubject"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep8_ClickRunFlow"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep8_GoToOneDrive"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep8_DownloadJson"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep8_UploadToApp"]
                            </MudListItem>
                        </MudList>

                        <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">@L["GuideStep8_ExpectedFormat"]</MudText>
                        <MudPaper Class="pa-3" Elevation="0" Style="background: var(--mud-palette-background-gray);">
                            <pre style="font-size: 0.8rem; margin: 0;">{
  "events": [
    {
      "subject": "Project Standup",
      "start": { "dateTime": "2024-01-15T09:00:00", "timeZone": "UTC" },
      "end": { "dateTime": "2024-01-15T09:30:00", "timeZone": "UTC" },
      "isAllDay": false
    }
  ],
  "exportDate": "2025-01-15T14:30:00Z",
  "subjectFilter": "Project Standup"
}</pre>
                        </MudPaper>

                        <MudAlert Severity="Severity.Success" Class="mt-4" Variant="Variant.Filled">
                            <MudText Typo="Typo.subtitle1"><strong>@L["GuideStep8_Congratulations"]</strong></MudText>
                            <MudText Typo="Typo.body2">
                                @L["GuideStep8_FlowComplete"]
                            </MudText>
                        </MudAlert>

                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large"
                                   StartIcon="@Icons.Material.Filled.Home" Href="/" Class="mt-4" FullWidth="true">
                            @L["GuideStep8_ReturnToHome"]
                        </MudButton>
                    </MudCardContent>
                </MudCard>
            </ItemContent>
        </MudTimelineItem>
    </MudTimeline>

    @* Troubleshooting Section *@
    <MudExpansionPanels Class="mt-4">
        <MudExpansionPanel Text="@L["Troubleshooting"]" Icon="@Icons.Material.Filled.Build">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Error" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" />
                        @L["Troubleshoot_Unauthorized"]
                    </MudText>
                    <MudList T="string" Dense="true">
                        <MudListItem>@L["Troubleshoot_Unauthorized1"]</MudListItem>
                        <MudListItem>@L["Troubleshoot_Unauthorized2"]</MudListItem>
                    </MudList>

                    <MudText Typo="Typo.subtitle2" Color="Color.Error" Class="mt-3 mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" />
                        @L["Troubleshoot_NoEvents"]
                    </MudText>
                    <MudList T="string" Dense="true">
                        <MudListItem>@L["Troubleshoot_NoEvents1"]</MudListItem>
                        <MudListItem>@L["Troubleshoot_NoEvents2"]</MudListItem>
                        <MudListItem>@L["Troubleshoot_NoEvents3"]</MudListItem>
                    </MudList>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Error" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" />
                        @L["Troubleshoot_NoFile"]
                    </MudText>
                    <MudList T="string" Dense="true">
                        <MudListItem>@L["Troubleshoot_NoFile1"]</MudListItem>
                        <MudListItem>@L["Troubleshoot_NoFile2"]</MudListItem>
                        <MudListItem>@L["Troubleshoot_NoFile3"]</MudListItem>
                    </MudList>

                    <MudText Typo="Typo.subtitle2" Color="Color.Error" Class="mt-3 mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" />
                        @L["Troubleshoot_InvalidJson"]
                    </MudText>
                    <MudList T="string" Dense="true">
                        <MudListItem>@L["Troubleshoot_InvalidJson1"]</MudListItem>
                        <MudListItem>@L["Troubleshoot_InvalidJson2"]</MudListItem>
                        <MudListItem>@L["Troubleshoot_InvalidJson3"]</MudListItem>
                    </MudList>
                </MudItem>
            </MudGrid>
        </MudExpansionPanel>

        <MudExpansionPanel Text="@L["SecurityAndPrivacy"]" Icon="@Icons.Material.Filled.Security">
            <MudList T="string" Dense="true">
                <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                    @L["Security_RunsInTenant"]
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                    @L["Security_NoExternalData"]
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                    @L["Security_StoredInOneDrive"]
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                    @L["Security_CanDelete"]
                </MudListItem>
            </MudList>
        </MudExpansionPanel>
    </MudExpansionPanels>
</MudContainer>

@code {
    private bool[] _completedSteps = new bool[8];

    private double GetProgressPercentage() => (_completedSteps.Count(s => s) / 8.0) * 100;

    private Color GetStepColor(int stepIndex) => _completedSteps[stepIndex] ? Color.Success : Color.Primary;

    protected override void OnInitialized()
    {
        L.OnLanguageChanged += OnLanguageChanged;
    }

    private void OnLanguageChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        L.OnLanguageChanged -= OnLanguageChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadProgressFromStorage();
        }
    }

    private async Task LoadProgressFromStorage()
    {
        try
        {
            var savedProgress = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "guideProgressMud");
            if (!string.IsNullOrEmpty(savedProgress))
            {
                var completed = System.Text.Json.JsonSerializer.Deserialize<bool[]>(savedProgress);
                if (completed != null && completed.Length == 8)
                {
                    _completedSteps = completed;
                    StateHasChanged();
                }
            }
        }
        catch { }
    }

    private async Task SaveProgressToStorage()
    {
        try
        {
            var json = System.Text.Json.JsonSerializer.Serialize(_completedSteps);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "guideProgressMud", json);
        }
        catch { }
    }
}

<style>
    code {
        background-color: rgba(0, 0, 0, 0.05);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Consolas', 'Courier New', monospace;
    }
    pre {
        background-color: rgba(0, 0, 0, 0.05);
        padding: 8px 12px;
        border-radius: 4px;
        overflow-x: auto;
    }
</style>
