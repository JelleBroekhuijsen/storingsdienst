@page "/guide/power-automate"
@inject IJSRuntime JSRuntime
@inject ILocalizationService L
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>@L["PowerAutomateSetupGuide"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudIcon Icon="@Icons.Custom.Brands.Microsoft" Size="Size.Large" />
        <MudText Typo="Typo.h4">@L["PowerAutomateSetupGuide"]</MudText>
    </MudStack>
    <MudText Typo="Typo.subtitle1" Class="mud-text-secondary mb-4">
        @L["ExportM365CalendarToJson"]
    </MudText>

    <MudProgressLinear Color="Color.Primary" Value="@GetProgressPercentage()" Class="mb-2" />
    <MudText Typo="Typo.body2" Class="mud-text-secondary mb-4">
        @string.Format(L["StepsCompleted"], _completedSteps.Count(s => s))
    </MudText>

    <MudTimeline TimelinePosition="TimelinePosition.Start">
        @* Step 1: Create New Power Automate Flow *@
        <MudTimelineItem Color="@GetStepColor(0)" Size="Size.Medium">
            <ItemDot>
                <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" />
            </ItemDot>
            <ItemContent>
                <MudCard id="step-0" Elevation="1" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.h6">@L["GuideStep1Title"]</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Setup"] - ~2 @L["Minutes"]</MudText>
                                </div>
                                <MudCheckBox T="bool" Value="_completedSteps[0]" ValueChanged="@(v => OnStepCompleted(0, v))"
                                             Color="Color.Success" Label="@L["Complete"]" />
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep1_GoTo"] <MudLink Href="https://make.powerautomate.com" Target="_blank">make.powerautomate.com</MudLink>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep1_ClickCreate"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep1_EnterName"] <CopyableCode Value="@L["GuideStep1_FlowName"]" OnCopy="ShowCopyConfirmation" />
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep1_SelectTrigger"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep1_ClickCreateBtn"]
                            </MudListItem>
                        </MudList>
                        <MudAlert Severity="Severity.Info" Class="mt-3" Dense="true">
                            <strong>@L["GuideStep1_Tip"]</strong>
                        </MudAlert>
                    </MudCardContent>
                </MudCard>
            </ItemContent>
        </MudTimelineItem>

        @* Step 2: Add Input Parameters *@
        <MudTimelineItem Color="@GetStepColor(1)" Size="Size.Medium">
            <ItemDot>
                <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Small" />
            </ItemDot>
            <ItemContent>
                <MudCard id="step-1" Elevation="1" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.h6">@L["GuideStep2Title"]</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Setup"] - ~1 @L["Minute"]</MudText>
                                </div>
                                <MudCheckBox T="bool" Value="_completedSteps[1]" ValueChanged="@(v => OnStepCompleted(1, v))"
                                             Color="Color.Success" Label="@L["Complete"]" />
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep2_AddInput"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep2_SelectText"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep2_InputName"] <CopyableCode Value="@L["GuideStep2_SubjectFilter"]" OnCopy="ShowCopyConfirmation" />
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep2_MarkRequired"]
                            </MudListItem>
                        </MudList>
                    </MudCardContent>
                </MudCard>
            </ItemContent>
        </MudTimelineItem>

        @* Step 3: List Calendar Events *@
        <MudTimelineItem Color="@GetStepColor(2)" Size="Size.Medium">
            <ItemDot>
                <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Small" />
            </ItemDot>
            <ItemContent>
                <MudCard id="step-2" Elevation="1" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.h6">@L["GuideStep3Title"]</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Configure"] - ~2 @L["Minutes"]</MudText>
                                </div>
                                <MudCheckBox T="bool" Value="_completedSteps[2]" ValueChanged="@(v => OnStepCompleted(2, v))"
                                             Color="Color.Success" Label="@L["Complete"]" />
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep3_NewStep"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep3_SearchAction"] <CopyableCode Value="Get calendar view of events (V3)" OnCopy="ShowCopyConfirmation" />
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep3_SignInPrompt"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                <MudText Typo="Typo.body2"><strong>@L["GuideStep3_ConfigureParams"]</strong></MudText>
                            </MudListItem>
                            <MudList T="string" Dense="true" Class="param-list">
                                <MudListItem Class="param-item">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudText Typo="Typo.body2" Class="param-label">@L["GuideStep3_CalendarId"]</MudText>
                                        <CopyableCode Value="Calendar" OnCopy="ShowCopyConfirmation" />
                                    </MudStack>
                                </MudListItem>
                                <MudListItem Class="param-item">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudText Typo="Typo.body2" Class="param-label">@L["GuideStep3_StartTime"]</MudText>
                                        <CopyableCode Value="@("@addDays(utcNow(), -365)")" OnCopy="ShowCopyConfirmation" />
                                    </MudStack>
                                </MudListItem>
                                <MudListItem Class="param-item">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudText Typo="Typo.body2" Class="param-label">@L["GuideStep3_EndTime"]</MudText>
                                        <CopyableCode Value="@("@utcNow()")" OnCopy="ShowCopyConfirmation" />
                                    </MudStack>
                                </MudListItem>
                                <MudListItem Class="param-item">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudText Typo="Typo.body2" Class="param-label">@L["GuideStep3_TopCount"]</MudText>
                                        <CopyableCode Value="1000" OnCopy="ShowCopyConfirmation" />
                                    </MudStack>
                                </MudListItem>
                                <MudListItem Class="param-item">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudText Typo="Typo.body2" Class="param-label">@L["GuideStep3_Search"]</MudText>
                                        <CopyableCode Value="@("@triggerBody()?['text']")" OnCopy="ShowCopyConfirmation" />
                                    </MudStack>
                                </MudListItem>
                            </MudList>
                        </MudList>
                    </MudCardContent>
                </MudCard>
            </ItemContent>
        </MudTimelineItem>

        @* Step 4: Transform to Required JSON Format *@
        <MudTimelineItem Color="@GetStepColor(3)" Size="Size.Medium">
            <ItemDot>
                <MudIcon Icon="@Icons.Material.Filled.Transform" Size="Size.Small" />
            </ItemDot>
            <ItemContent>
                <MudCard id="step-3" Elevation="1" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.h6">@L["GuideStep4Title"]</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Configure"] - ~3 @L["Minutes"]</MudText>
                                </div>
                                <MudCheckBox T="bool" Value="_completedSteps[3]" ValueChanged="@(v => OnStepCompleted(3, v))"
                                             Color="Color.Success" Label="@L["Complete"]" />
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep3_NewStep"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep4_SearchAction"] <CopyableCode Value="Select" OnCopy="ShowCopyConfirmation" /> @L["GuideStep4_DataOperation"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep4_From"] <CopyableCode Value="@("@outputs('Get_calendar_view_of_events_(V3)')?['body/value']")" OnCopy="ShowCopyConfirmation" />
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep4_ClickMap"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                <MudText Typo="Typo.body2"><strong>@L["GuideStep4_FieldMappings"]</strong></MudText>
                            </MudListItem>
                            <MudList T="string" Dense="true" Class="param-list">
                                <MudListItem Class="param-item">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <CopyableCode Value="subject" OnCopy="ShowCopyConfirmation" />
                                        <MudText Typo="Typo.body2">→</MudText>
                                        <CopyableCode Value="@("@item()?['subject']")" OnCopy="ShowCopyConfirmation" />
                                    </MudStack>
                                </MudListItem>
                                <MudListItem Class="param-item">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <CopyableCode Value="start" OnCopy="ShowCopyConfirmation" />
                                        <MudText Typo="Typo.body2">→</MudText>
                                        <CopyableCode Value="@("@item()?['startWithTimeZone']")" OnCopy="ShowCopyConfirmation" />
                                    </MudStack>
                                </MudListItem>
                                <MudListItem Class="param-item">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <CopyableCode Value="end" OnCopy="ShowCopyConfirmation" />
                                        <MudText Typo="Typo.body2">→</MudText>
                                        <CopyableCode Value="@("@item()?['endWithTimeZone']")" OnCopy="ShowCopyConfirmation" />
                                    </MudStack>
                                </MudListItem>
                                <MudListItem Class="param-item">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <CopyableCode Value="isAllDay" OnCopy="ShowCopyConfirmation" />
                                        <MudText Typo="Typo.body2">→</MudText>
                                        <CopyableCode Value="@("@item()?['isAllDay']")" OnCopy="ShowCopyConfirmation" />
                                    </MudStack>
                                </MudListItem>
                            </MudList>
                        </MudList>
                    </MudCardContent>
                </MudCard>
            </ItemContent>
        </MudTimelineItem>

        @* Step 5: Create JSON Wrapper *@
        <MudTimelineItem Color="@GetStepColor(4)" Size="Size.Medium">
            <ItemDot>
                <MudIcon Icon="@Icons.Material.Filled.Code" Size="Size.Small" />
            </ItemDot>
            <ItemContent>
                <MudCard id="step-4" Elevation="1" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.h6">@L["GuideStep5Title"]</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Configure"] - ~1 @L["Minute"]</MudText>
                                </div>
                                <MudCheckBox T="bool" Value="_completedSteps[4]" ValueChanged="@(v => OnStepCompleted(4, v))"
                                             Color="Color.Success" Label="@L["Complete"]" />
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep3_NewStep"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep5_SearchAction"] <CopyableCode Value="Compose" OnCopy="ShowCopyConfirmation" /> @L["GuideStep5_DataOperation"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep5_InputsField"]
                            </MudListItem>
                            <MudList T="string" Dense="true" Class="param-list">
                                <MudListItem Class="param-item">
                                    <CopyableCode Value="@JsonWrapperCode" OnCopy="ShowCopyConfirmation" IsBlock="true" />
                                </MudListItem>
                            </MudList>
                        </MudList>
                    </MudCardContent>
                </MudCard>
            </ItemContent>
        </MudTimelineItem>

        @* Step 6: Save to OneDrive *@
        <MudTimelineItem Color="@GetStepColor(5)" Size="Size.Medium">
            <ItemDot>
                <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Size="Size.Small" />
            </ItemDot>
            <ItemContent>
                <MudCard id="step-5" Elevation="1" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.h6">@L["GuideStep6Title"]</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Output"] - ~2 @L["Minutes"]</MudText>
                                </div>
                                <MudCheckBox T="bool" Value="_completedSteps[5]" ValueChanged="@(v => OnStepCompleted(5, v))"
                                             Color="Color.Success" Label="@L["Complete"]" />
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep3_NewStep"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep6_SearchAction"] <CopyableCode Value="Create file" OnCopy="ShowCopyConfirmation" /> @L["GuideStep6_OneDriveBusiness"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep3_SignInPrompt"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                <MudText Typo="Typo.body2"><strong>@L["GuideStep6_ConfigureFile"]</strong></MudText>
                            </MudListItem>
                            <MudList T="string" Dense="true" Class="param-list">
                                <MudListItem Class="param-item">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudText Typo="Typo.body2" Class="param-label">@L["GuideStep6_FolderPath"]</MudText>
                                        <CopyableCode Value="/Documents/CalendarExports" OnCopy="ShowCopyConfirmation" />
                                    </MudStack>
                                </MudListItem>
                                <MudListItem Class="param-item">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudText Typo="Typo.body2" Class="param-label">@L["GuideStep6_FileName"]</MudText>
                                        <CopyableCode Value="@("calendar_export_@{formatDateTime(utcNow(), 'yyyyMMdd_HHmmss')}.json")" OnCopy="ShowCopyConfirmation" />
                                    </MudStack>
                                </MudListItem>
                                <MudListItem Class="param-item">
                                    <MudText Typo="Typo.body2">@L["GuideStep6_FileContent"]</MudText>
                                </MudListItem>
                            </MudList>
                        </MudList>

                        <MudAlert Severity="Severity.Info" Class="mt-3" Dense="true">
                            <strong>@L["GuideStep6_SharePointAlt"]</strong>
                        </MudAlert>
                    </MudCardContent>
                </MudCard>
            </ItemContent>
        </MudTimelineItem>

        @* Step 7: Test & Export Your Flow *@
        <MudTimelineItem Color="@GetStepColor(6)" Size="Size.Medium">
            <ItemDot>
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" />
            </ItemDot>
            <ItemContent>
                <MudCard id="step-6" Elevation="1" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.h6">@L["GuideStep7Title"]</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Test"] - ~2 @L["Minutes"]</MudText>
                                </div>
                                <MudCheckBox T="bool" Value="_completedSteps[6]" ValueChanged="@(v => OnStepCompleted(6, v))"
                                             Color="Color.Success" Label="@L["Complete"]" />
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText Typo="Typo.subtitle2" Class="mb-2">@L["GuideStep7_RunningFlow"]</MudText>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep1_GoTo"] <MudLink Href="https://make.powerautomate.com" Target="_blank">make.powerautomate.com</MudLink>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep7_ClickMyFlows"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep7_FindFlow"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep7_EnterSubject"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep7_ClickRunFlow"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep7_GoToOneDrive"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep7_DownloadJson"]
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.ChevronRight">
                                @L["GuideStep7_UploadToApp"]
                            </MudListItem>
                        </MudList>

                        <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">@L["GuideStep7_ExpectedFormat"]</MudText>
                        <MudPaper Class="pa-3 code-block" Elevation="0">
                            <pre class="json-preview">{
  "events": [
    {
      "subject": "Project Standup",
      "start": { "dateTime": "2024-01-15T09:00:00", "timeZone": "UTC" },
      "end": { "dateTime": "2024-01-15T09:30:00", "timeZone": "UTC" },
      "isAllDay": false
    }
  ],
  "exportDate": "2025-01-15T14:30:00Z",
  "subjectFilter": "Project Standup"
}</pre>
                        </MudPaper>

                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large"
                                   StartIcon="@Icons.Material.Filled.Home" Href="/" Class="mt-4" FullWidth="true">
                            @L["GuideStep7_ReturnToHome"]
                        </MudButton>
                    </MudCardContent>
                </MudCard>
            </ItemContent>
        </MudTimelineItem>
    </MudTimeline>

    @* Congratulations Banner - only shown when all steps are completed *@
    @if (AllStepsCompleted)
    {
        <MudAlert Severity="Severity.Success" Class="mb-4" Variant="Variant.Filled">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Celebration" Size="Size.Large" />
                <div>
                    <MudText Typo="Typo.h6"><strong>@L["GuideStep7_Congratulations"]</strong></MudText>
                    <MudText Typo="Typo.body2">
                        @L["GuideStep7_FlowComplete"]
                    </MudText>
                </div>
            </MudStack>
        </MudAlert>
    }

    @* Troubleshooting Section *@
    <MudExpansionPanels Class="mt-4">
        <MudExpansionPanel Text="@L["Troubleshooting"]" Icon="@Icons.Material.Filled.Build">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Error" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" />
                        @L["Troubleshoot_Unauthorized"]
                    </MudText>
                    <MudList T="string" Dense="true">
                        <MudListItem>@L["Troubleshoot_Unauthorized1"]</MudListItem>
                        <MudListItem>@L["Troubleshoot_Unauthorized2"]</MudListItem>
                    </MudList>

                    <MudText Typo="Typo.subtitle2" Color="Color.Error" Class="mt-3 mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" />
                        @L["Troubleshoot_NoEvents"]
                    </MudText>
                    <MudList T="string" Dense="true">
                        <MudListItem>@L["Troubleshoot_NoEvents1"]</MudListItem>
                        <MudListItem>@L["Troubleshoot_NoEvents2"]</MudListItem>
                        <MudListItem>@L["Troubleshoot_NoEvents3"]</MudListItem>
                    </MudList>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Error" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" />
                        @L["Troubleshoot_NoFile"]
                    </MudText>
                    <MudList T="string" Dense="true">
                        <MudListItem>@L["Troubleshoot_NoFile1"]</MudListItem>
                        <MudListItem>@L["Troubleshoot_NoFile2"]</MudListItem>
                        <MudListItem>@L["Troubleshoot_NoFile3"]</MudListItem>
                    </MudList>

                    <MudText Typo="Typo.subtitle2" Color="Color.Error" Class="mt-3 mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" />
                        @L["Troubleshoot_InvalidJson"]
                    </MudText>
                    <MudList T="string" Dense="true">
                        <MudListItem>@L["Troubleshoot_InvalidJson1"]</MudListItem>
                        <MudListItem>@L["Troubleshoot_InvalidJson2"]</MudListItem>
                        <MudListItem>@L["Troubleshoot_InvalidJson3"]</MudListItem>
                    </MudList>
                </MudItem>
            </MudGrid>
        </MudExpansionPanel>

        <MudExpansionPanel Text="@L["SecurityAndPrivacy"]" Icon="@Icons.Material.Filled.Security">
            <MudList T="string" Dense="true">
                <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                    @L["Security_RunsInTenant"]
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                    @L["Security_NoExternalData"]
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                    @L["Security_StoredInOneDrive"]
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">
                    @L["Security_CanDelete"]
                </MudListItem>
            </MudList>
        </MudExpansionPanel>
    </MudExpansionPanels>
</MudContainer>

@code {
    private bool[] _completedSteps = new bool[7];
    private const int TotalSteps = 7;

    private const string JsonWrapperCode = @"{
    ""events"": ""@{body('Select')}"",
    ""exportDate"": ""@{utcNow()}"",
    ""subjectFilter"": ""@{triggerBody()?['text']}""
}";

    private double GetProgressPercentage() => (_completedSteps.Count(s => s) / (double)TotalSteps) * 100;

    private Color GetStepColor(int stepIndex) => _completedSteps[stepIndex] ? Color.Success : Color.Primary;

    private bool AllStepsCompleted => _completedSteps.All(s => s);

    protected override void OnInitialized()
    {
        L.OnLanguageChanged += OnLanguageChanged;
    }

    private void OnLanguageChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        L.OnLanguageChanged -= OnLanguageChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadProgressFromStorage();
        }
    }

    private async Task LoadProgressFromStorage()
    {
        try
        {
            var savedProgress = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "guideProgressMud");
            if (!string.IsNullOrEmpty(savedProgress))
            {
                var completed = System.Text.Json.JsonSerializer.Deserialize<bool[]>(savedProgress);
                if (completed != null && completed.Length == TotalSteps)
                {
                    _completedSteps = completed;
                    StateHasChanged();
                }
            }
        }
        catch { }
    }

    private async Task SaveProgressToStorage()
    {
        try
        {
            var json = System.Text.Json.JsonSerializer.Serialize(_completedSteps);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "guideProgressMud", json);
        }
        catch { }
    }

    private async Task OnStepCompleted(int stepIndex, bool value)
    {
        _completedSteps[stepIndex] = value;
        await SaveProgressToStorage();
        StateHasChanged();

        // If step was marked complete, scroll to the next step
        if (value && stepIndex < TotalSteps - 1)
        {
            var nextStepId = $"step-{stepIndex + 1}";
            await JSRuntime.InvokeVoidAsync("scrollToElement", nextStepId);
        }
    }

    private void ShowCopyConfirmation()
    {
        Snackbar.Add(L["CopiedToClipboard"], Severity.Success, config =>
        {
            config.VisibleStateDuration = 1500;
            config.ShowCloseIcon = false;
        });
    }
}

<style>
    /* Parameter list styling */
    .param-list {
        margin-left: 24px !important;
        border-left: 2px solid var(--mud-palette-primary);
        padding-left: 8px !important;
    }

    .param-item {
        padding-top: 4px !important;
        padding-bottom: 4px !important;
    }

    .param-label {
        font-weight: 600;
        color: var(--mud-palette-text-secondary);
        min-width: 100px;
    }

    /* Code block styling */
    .code-block {
        background: var(--mud-palette-background-gray);
        border: 1px solid var(--mud-palette-lines-default);
        border-radius: 8px;
    }

    .json-preview {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.8rem;
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
        color: var(--mud-palette-text-primary);
    }
</style>
