@page "/"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@inject IMeetingAnalysisService MeetingAnalysisService
@inject IExcelExportService ExcelExportService
@inject JsonImportService JsonImportService
@inject ICalendarDataService CalendarDataService
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar
@inject ILocalizationService L
@implements IDisposable

<PageTitle>@L["AppTitle"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    <MudText Typo="Typo.h4" Class="mb-2">@L["M365MeetingDaysTracker"]</MudText>
    <MudText Typo="Typo.subtitle1" Class="mb-4 mud-text-secondary">
        @L["TrackAndAnalyzeMeetings"]
    </MudText>

    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-3">@L["Step1SelectDataSource"]</MudText>
        <MudToggleGroup T="DataSourceMode" @bind-Value="_selectedMode" Color="Color.Primary"
                        SelectionMode="SelectionMode.SingleSelection" CheckMark="true">
            <MudToggleItem Value="DataSourceMode.GraphApi">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Custom.Brands.Microsoft" />
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body1">@L["MicrosoftGraphApi"]</MudText>
                        <MudText Typo="Typo.caption" Style="opacity: 0.85;">
                            @L["RequiresAzureAd"]
                        </MudText>
                    </MudStack>
                </MudStack>
            </MudToggleItem>
            <MudToggleItem Value="DataSourceMode.JsonImport">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.UploadFile" />
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body1">@L["JsonFileUpload"]</MudText>
                        <MudText Typo="Typo.caption" Style="opacity: 0.85;">
                            @L["GeneratedByPowerAutomate"]
                        </MudText>
                    </MudStack>
                </MudStack>
            </MudToggleItem>
        </MudToggleGroup>
    </MudPaper>

    @if (_selectedMode == DataSourceMode.GraphApi)
    {
        <MudPaper Class="pa-4 mb-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">@L["Step2SearchMeetingsGraphApi"]</MudText>

            <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
                <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" Size="Size.Small" />
                @L["GraphApiAuthInfo"]
            </MudAlert>

            <AuthorizeView>
                <Authorized>
                    <MudTextField T="string" @bind-Value="_searchSubject" Label="@L["MeetingSubject"]"
                                  Placeholder="@L["EnterMeetingTitleToSearch"]"
                                  Variant="Variant.Outlined" Class="mb-3"
                                  Disabled="_isLoading"
                                  HelperText="@string.Format(L["SearchingFromTo"], _startDate.ToString("yyyy-MM-dd"), DateTime.Now.ToString("yyyy-MM-dd"))" />

                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               OnClick="SearchMeetingsAsync"
                               Disabled="@(_isLoading || string.IsNullOrWhiteSpace(_searchSubject))"
                               StartIcon="@(_isLoading ? null : Icons.Material.Filled.Search)">
                        @if (_isLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>@L["Searching"]</span>
                        }
                        else
                        {
                            <span>@L["SearchMeetings"]</span>
                        }
                    </MudButton>
                </Authorized>
                <NotAuthorized>
                    <MudText Typo="Typo.body1" Class="mud-text-secondary mb-3">
                        @L["PleaseSignInToSearchCalendar"]
                    </MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="authentication/login"
                               StartIcon="@Icons.Material.Filled.Login">
                        @L["SignInWithMicrosoft"]
                    </MudButton>
                </NotAuthorized>
            </AuthorizeView>
        </MudPaper>
    }
    else
    {
        <MudPaper Class="pa-4 mb-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">@L["Step2UploadJsonFile"]</MudText>

            <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
                <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" Size="Size.Small" />
                @L["UploadJsonInfo"]
                <MudLink Href="/guide/power-automate" Class="ml-1">@L["ViewSetupGuide"]</MudLink>
            </MudAlert>

            <MudFileUpload T="IBrowserFile" Accept=".json" FilesChanged="HandleFileSelected"
                           MaximumFileCount="1" Class="mb-3" Disabled="_isLoading">
                <ActivatorContent>
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.CloudUpload">
                        @L["SelectJsonFile"]
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>
            <MudText Typo="Typo.caption" Class="mud-text-secondary mb-3">
                @L["MaxFileSizeInfo"]
            </MudText>

            @if (_fileSelected)
            {
                @if (_recurringSubjects != null && _recurringSubjects.Any())
                {
                    <MudSelect T="string" @bind-Value="_searchSubject" Label="@L["SelectRecurringMeetingSubject"]"
                               Variant="Variant.Outlined" Class="mb-3"
                               Disabled="_isLoading"
                               HelperText="@L["ChooseFromRecurringMeetings"]"
                               Placeholder="@L["SelectRecurringMeetingPlaceholder"]">
                        @foreach (var subject in _recurringSubjects)
                        {
                            <MudSelectItem Value="@subject">@subject</MudSelectItem>
                        }
                    </MudSelect>
                }
                else
                {
                    <MudTextField T="string" @bind-Value="_searchSubject" Label="@L["MeetingSubjectFilter"]"
                                  Placeholder="@L["EnterMeetingTitleToFilter"]"
                                  Variant="Variant.Outlined" Class="mb-3"
                                  Disabled="_isLoading"
                                  HelperText="@L["OnlyEventsContainingText"]" />
                }

                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                           OnClick="ProcessJsonFileAsync"
                           Disabled="@(_isLoading || string.IsNullOrWhiteSpace(_searchSubject))"
                           StartIcon="@(_isLoading ? null : Icons.Material.Filled.Settings)">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>@L["Processing"]</span>
                    }
                    else
                    {
                        <span>@L["ProcessFile"]</span>
                    }
                </MudButton>
            }
        </MudPaper>
    }

    @if (_monthlyResults != null && _monthlyResults.Any())
    {
        <MudPaper Class="mb-4" Elevation="2">
            <MudTable Items="@_monthlyResults" Hover="true" Striped="true" Dense="true">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">@L["MonthlyBreakdown"]</MudText>
                    <MudSpacer />
                    <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.GridOn"
                               OnClick="ExportToExcelAsync">
                        @L["ExportToExcel"]
                    </MudButton>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>@L["Month"]</MudTh>
                    <MudTh>@L["Year"]</MudTh>
                    <MudTh Style="text-align:right">@L["TotalDays"]</MudTh>
                    <MudTh Style="text-align:right">@L["Weekdays"]</MudTh>
                    <MudTh Style="text-align:right">@L["Saturdays"]</MudTh>
                    <MudTh Style="text-align:right">@L["Sundays"]</MudTh>
                    <MudTh Style="text-align:right">@L["Holidays"]</MudTh>
                    <MudTh>@L["HolidayDetails"]</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="@L["Month"]">@context.MonthName</MudTd>
                    <MudTd DataLabel="@L["Year"]">@context.Year</MudTd>
                    <MudTd DataLabel="@L["Total"]" Style="text-align:right">
                        <MudText Typo="Typo.body2"><b>@context.TotalMeetingDays</b></MudText>
                    </MudTd>
                    <MudTd DataLabel="@L["Weekdays"]" Style="text-align:right">@context.WeekdayCount</MudTd>
                    <MudTd DataLabel="@L["Saturdays"]" Style="text-align:right">@context.SaturdayCount</MudTd>
                    <MudTd DataLabel="@L["Sundays"]" Style="text-align:right">@context.SundayCount</MudTd>
                    <MudTd DataLabel="@L["Holidays"]" Style="text-align:right">@context.HolidayCount</MudTd>
                    <MudTd DataLabel="@L["HolidayDetails"]">
                        @if (context.HolidayNames.Any())
                        {
                            <MudText Typo="Typo.body2">@string.Join(", ", context.HolidayNames)</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">-</MudText>
                        }
                    </MudTd>
                </RowTemplate>
                <FooterContent>
                    <MudTh colspan="2"><strong>@L["Total"]</strong></MudTh>
                    <MudTh Style="text-align:right"><strong>@_monthlyResults.Sum(m => m.TotalMeetingDays)</strong></MudTh>
                    <MudTh Style="text-align:right">@_monthlyResults.Sum(m => m.WeekdayCount)</MudTh>
                    <MudTh Style="text-align:right">@_monthlyResults.Sum(m => m.SaturdayCount)</MudTh>
                    <MudTh Style="text-align:right">@_monthlyResults.Sum(m => m.SundayCount)</MudTh>
                    <MudTh Style="text-align:right">@_monthlyResults.Sum(m => m.HolidayCount)</MudTh>
                    <MudTh></MudTh>
                </FooterContent>
            </MudTable>
            <MudCardContent>
                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                    @(string.Format(L["ShowingResultsForSubject"], _searchSubject))
                </MudText>
            </MudCardContent>
        </MudPaper>

        <MudPaper Class="pa-4 mb-4" Elevation="2">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
                <MudText Typo="Typo.h6">@L["VerifyPaystubData"]</MudText>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.AddCircle"
                           OnClick="AddVerificationComponent">
                    @L["AddAnotherMonth"]
                </MudButton>
            </MudStack>

            <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
                <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" Size="Size.Small" />
                @L["VerifyPaystubInfo"]
            </MudAlert>

            @foreach (var verificationId in _verificationComponentIds)
            {
                <PaystubVerification
                    MonthlyResults="_monthlyResults"
                    Id="@verificationId"
                    AllowRemove="@(_verificationComponentIds.Count > 1)"
                    OnRemoveClicked="@(() => RemoveVerificationComponent(verificationId))" />
            }
        </MudPaper>
    }

    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-4">@L["AboutThisApp"]</MudText>

        <MudGrid Spacing="3" Class="mb-4 equal-height-cards">
            <MudItem xs="12" md="4">
                <MudCard Elevation="0" Style="background-color: var(--mud-palette-background-gray); height: 100%;">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.Speed" Color="Color.Secondary" />
                            <MudText Typo="Typo.subtitle2">@L["RapidAIBuilding"]</MudText>
                        </MudStack>
                        <MudText Typo="Typo.body2" Class="mb-3">
                            @L["RapidAIBuildingDesc"]
                        </MudText>
                        <MudStack Spacing="1">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["RapidFeature1"]</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["RapidFeature2"]</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["RapidFeature3"]</MudText>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudCard Elevation="0" Style="background-color: var(--mud-palette-background-gray); height: 100%;">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.SmartToy" Color="Color.Secondary" />
                            <MudText Typo="Typo.subtitle2">@L["AgenticWorkflows"]</MudText>
                        </MudStack>
                        <MudText Typo="Typo.body2" Class="mb-3">
                            @L["AgenticWorkflowsDesc"]
                        </MudText>
                        <MudStack Spacing="1">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["AgenticFeature1"]</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["AgenticFeature2"]</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["AgenticFeature3"]</MudText>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudCard Elevation="0" Style="background-color: var(--mud-palette-background-gray); height: 100%;">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.Security" Color="Color.Secondary" />
                            <MudText Typo="Typo.subtitle2">@L["EnterpriseIntegration"]</MudText>
                        </MudStack>
                        <MudText Typo="Typo.body2" Class="mb-3">
                            @L["EnterpriseIntegrationDesc"]
                        </MudText>
                        <MudStack Spacing="1">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["EnterpriseFeature1"]</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["EnterpriseFeature2"]</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["EnterpriseFeature3"]</MudText>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-4" />

        <MudText Typo="Typo.subtitle1" Class="mb-2" Style="font-weight: 600;">@L["HowWeCanHelp"]</MudText>
        <MudText Typo="Typo.body2" Class="mb-3 mud-text-secondary">
            @L["HowWeCanHelpDescription"]
        </MudText>

        <MudGrid Spacing="3" Class="mb-4 equal-height-cards">
            <MudItem xs="12" md="4">
                <MudCard Elevation="0" Style="background-color: var(--mud-palette-background-gray); height: 100%;">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.Psychology" Color="Color.Secondary" />
                            <MudText Typo="Typo.subtitle2">@L["AIAdoption"]</MudText>
                        </MudStack>
                        <MudText Typo="Typo.body2" Class="mb-3">
                            @L["AIAdoptionDesc"]
                        </MudText>
                        <MudStack Spacing="1">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["AIFeature1"]</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["AIFeature2"]</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["AIFeature3"]</MudText>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudCard Elevation="0" Style="background-color: var(--mud-palette-background-gray); height: 100%;">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.Web" Color="Color.Secondary" />
                            <MudText Typo="Typo.subtitle2">@L["M365Portals"]</MudText>
                        </MudStack>
                        <MudText Typo="Typo.body2" Class="mb-3">
                            @L["M365PortalsDesc"]
                        </MudText>
                        <MudStack Spacing="1">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["M365Feature1"]</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["M365Feature2"]</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["M365Feature3"]</MudText>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudCard Elevation="0" Style="background-color: var(--mud-palette-background-gray); height: 100%;">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.AccountTree" Color="Color.Secondary" />
                            <MudText Typo="Typo.subtitle2">@L["ProcessAutomation"]</MudText>
                        </MudStack>
                        <MudText Typo="Typo.body2" Class="mb-3">
                            @L["ProcessAutomationDesc"]
                        </MudText>
                        <MudStack Spacing="1">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["AutomationFeature1"]</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["AutomationFeature2"]</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption">@L["AutomationFeature3"]</MudText>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-4" />

        <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">@L["BuiltWith"]</MudText>

        <MudGrid Spacing="3" Class="equal-height-cards">
            <MudItem xs="12" md="4">
                <MudCard Elevation="0" Style="background-color: var(--mud-palette-background-gray); height: 100%;">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.Psychology" Color="Color.Secondary" />
                            <MudText Typo="Typo.subtitle2">@L["AIPoweredDevelopment"]</MudText>
                        </MudStack>
                        <MudStack Spacing="2">
                            <div>
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@L["ClaudeCode"]</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["ClaudeCodeDesc"]</MudText>
                            </div>
                            <div>
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@L["GitHubCopilot"]</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["GitHubCopilotDesc"]</MudText>
                            </div>
                            <div>
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@L["PlaywrightMCP"]</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["PlaywrightMCPDesc"]</MudText>
                            </div>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudCard Elevation="0" Style="background-color: var(--mud-palette-background-gray); height: 100%;">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.Cloud" Color="Color.Secondary" />
                            <MudText Typo="Typo.subtitle2">@L["DevOpsAndCloud"]</MudText>
                        </MudStack>
                        <MudStack Spacing="2">
                            <div>
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@L["GitHubActions"]</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["GitHubActionsDesc"]</MudText>
                            </div>
                            <div>
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@L["MicrosoftAzure"]</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["MicrosoftAzureDesc"]</MudText>
                            </div>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudCard Elevation="0" Style="background-color: var(--mud-palette-background-gray); height: 100%;">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.Code" Color="Color.Secondary" />
                            <MudText Typo="Typo.subtitle2">@L["TechnologyStack"]</MudText>
                        </MudStack>
                        <MudStack Spacing="2">
                            <div>
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@L["BlazorWebAssembly"]</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["BlazorDesc"]</MudText>
                            </div>
                            <div>
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@L["MicrosoftGraph"]</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["MicrosoftGraphDesc"]</MudText>
                            </div>
                            <div>
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@L["MudBlazor"]</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["MudBlazorDesc"]</MudText>
                            </div>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-4" />

        <MudStack Spacing="2">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="flex-wrap">
                <MudText Typo="Typo.body2" Class="mud-text-secondary">
                    @L["InterestedInSimilar"]
                </MudText>
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Small"
                           Href="mailto:consultancy@jll.io" StartIcon="@Icons.Material.Filled.Email">
                    @L["ContactUs"]
                </MudButton>
            </MudStack>
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="flex-wrap">
                <MudText Typo="Typo.body2" Class="mud-text-secondary">
                    @L["ViewSourceOnGitHub"]
                </MudText>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                           Href="https://github.com/JelleBroekhuijsen/storingsdienst" Target="_blank"
                           StartIcon="@Icons.Custom.Brands.GitHub">
                    @L["ViewOnGitHub"]
                </MudButton>
            </MudStack>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private enum DataSourceMode
    {
        GraphApi,
        JsonImport
    }

    private DataSourceMode _selectedMode = DataSourceMode.GraphApi;
    private string _searchSubject = string.Empty;
    private List<MonthlyBreakdown>? _monthlyResults;
    private bool _isLoading = false;
    private DateTime _startDate = DateTime.Now.AddYears(-1);
    private bool _fileSelected = false;
    private string? _jsonContent;
    private List<string>? _recurringSubjects;
    private List<string> _verificationComponentIds = new List<string> { Guid.NewGuid().ToString() };

    protected override void OnInitialized()
    {
        L.OnLanguageChanged += OnLanguageChanged;
    }

    private void OnLanguageChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        L.OnLanguageChanged -= OnLanguageChanged;
    }

    private void AddVerificationComponent()
    {
        _verificationComponentIds.Add(Guid.NewGuid().ToString());
    }

    private void RemoveVerificationComponent(string id)
    {
        if (_verificationComponentIds.Count > 1)
        {
            _verificationComponentIds.Remove(id);
        }
    }

    private async Task HandleFileSelected(IBrowserFile? file)
    {
        _fileSelected = false;
        _jsonContent = null;
        _recurringSubjects = null;
        _searchSubject = string.Empty;

        if (file == null)
        {
            return;
        }

        if (file.Size > 10 * 1024 * 1024) // 10 MB limit
        {
            Snackbar.Add(L["FileSizeExceeded"], Severity.Error);
            return;
        }

        if (!file.Name.EndsWith(".json", StringComparison.OrdinalIgnoreCase))
        {
            Snackbar.Add(L["PleaseSelectJsonFile"], Severity.Error);
            return;
        }

        try
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var reader = new System.IO.StreamReader(stream);
            _jsonContent = await reader.ReadToEndAsync();

            // Detect recurring subjects
            _recurringSubjects = await JsonImportService.GetRecurringSubjectsAsync(_jsonContent);

            _fileSelected = true;

            if (_recurringSubjects != null && _recurringSubjects.Any())
            {
                Snackbar.Add(string.Format(L["FileLoadedWithRecurring"], file.Name, _recurringSubjects.Count), Severity.Success);
            }
            else
            {
                Snackbar.Add(string.Format(L["FileLoadedEnterSubject"], file.Name), Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["ErrorReadingFile"], ex.Message), Severity.Error);
        }
    }

    private async Task ProcessJsonFileAsync()
    {
        _isLoading = true;
        _monthlyResults = null;

        try
        {
            if (string.IsNullOrWhiteSpace(_jsonContent))
            {
                Snackbar.Add(L["NoFileContentToProcess"], Severity.Error);
                return;
            }

            // Parse JSON and get events
            var events = await JsonImportService.ParseJsonFileAsync(
                _jsonContent,
                _searchSubject,
                _startDate,
                DateTime.Now);

            if (!events.Any())
            {
                Snackbar.Add(string.Format(L["NoEventsFoundMatchingSubject"], _searchSubject), Severity.Warning);
                return;
            }

            // Analyze meetings
            _monthlyResults = MeetingAnalysisService.AnalyzeMeetings(events);

            if (!_monthlyResults.Any())
            {
                Snackbar.Add(L["NoMeetingDaysFoundAfterAnalysis"], Severity.Warning);
                return;
            }

            Snackbar.Add(string.Format(L["SuccessfullyAnalyzedEvents"], events.Count, _monthlyResults.Sum(m => m.TotalMeetingDays)), Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["ErrorProcessingJsonFile"], ex.Message), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SearchMeetingsAsync()
    {
        _isLoading = true;
        _monthlyResults = null;

        try
        {
            // Call Graph API to fetch calendar events
            var events = await CalendarDataService.GetMeetingsBySubjectAsync(
                _searchSubject,
                _startDate,
                DateTime.Now);

            if (!events.Any())
            {
                Snackbar.Add(string.Format(L["NoEventsFoundInCalendar"], _searchSubject), Severity.Warning);
                return;
            }

            // Analyze the meetings
            _monthlyResults = MeetingAnalysisService.AnalyzeMeetings(events);

            if (!_monthlyResults.Any())
            {
                Snackbar.Add(L["NoMeetingDaysFoundAfterAnalysis"], Severity.Warning);
                return;
            }

            Snackbar.Add(string.Format(L["SuccessfullyFoundEvents"], events.Count, _monthlyResults.Sum(m => m.TotalMeetingDays)), Severity.Success);
        }
        catch (AccessTokenNotAvailableException ex)
        {
            // Token expired or not available - redirect to login
            ex.Redirect();
        }
        catch (UnauthorizedAccessException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (InvalidOperationException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["ErrorSearchingMeetings"], ex.Message), Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ExportToExcelAsync()
    {
        if (_monthlyResults == null || !_monthlyResults.Any())
        {
            Snackbar.Add(L["NoDataToExport"], Severity.Error);
            return;
        }

        try
        {
            var excelData = ExcelExportService.GenerateExcelReport(_monthlyResults, _searchSubject);
            var fileName = $"meeting_days_{_searchSubject.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";

            // Use JS interop to trigger download
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, Convert.ToBase64String(excelData));

            Snackbar.Add(L["ExcelFileDownloaded"], Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["ErrorExportingToExcel"], ex.Message), Severity.Error);
        }
    }
}
