@page "/"
@inject IMeetingAnalysisService MeetingAnalysisService
@inject IExcelExportService ExcelExportService
@inject JsonImportService JsonImportService
@inject IJSRuntime JSRuntime

<PageTitle>Meeting Days Tracker</PageTitle>

<div class="container mt-4">
    <h1 class="mb-4">M365 Meeting Days Tracker</h1>

    <p class="lead">
        Track and analyze meeting occurrences from your Microsoft 365 calendar.
        Choose between direct integration or JSON file import.
    </p>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong> @_errorMessage
            <button type="button" class="btn-close" @onclick="ClearError"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(_successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @_successMessage
            <button type="button" class="btn-close" @onclick="ClearSuccess"></button>
        </div>
    }

    <div class="card mb-4">
        <div class="card-header">
            <h5>Step 1: Select Data Source</h5>
        </div>
        <div class="card-body">
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="dataSource" id="graphApi"
                       checked="@(_selectedMode == DataSourceMode.GraphApi)"
                       @onclick="@(() => SelectMode(DataSourceMode.GraphApi))">
                <label class="btn btn-outline-primary" for="graphApi">
                    <i class="bi bi-microsoft"></i> Microsoft Graph API
                    <br><small class="text-muted">(Requires Azure AD app registration)</small>
                </label>

                <input type="radio" class="btn-check" name="dataSource" id="jsonImport"
                       checked="@(_selectedMode == DataSourceMode.JsonImport)"
                       @onclick="@(() => SelectMode(DataSourceMode.JsonImport))">
                <label class="btn btn-outline-primary" for="jsonImport">
                    <i class="bi bi-file-earmark-arrow-up"></i> JSON File Upload
                    <br><small class="text-muted">(Generated by Power Automate)</small>
                </label>
            </div>
        </div>
    </div>

    @if (_selectedMode == DataSourceMode.GraphApi)
    {
        <div class="card mb-4">
            <div class="card-header">
                <h5>Step 2: Search Meetings (Graph API)</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> This mode requires authentication with your Microsoft 365 account and an Azure AD app registration.
                    <br><strong>Note:</strong> Full Graph API integration is in progress. For now, please use JSON Import mode.
                </div>

                <AuthorizeView>
                    <Authorized>
                        <div class="mb-3">
                            <label for="subjectInput" class="form-label">Meeting Subject</label>
                            <input type="text" class="form-control" id="subjectInput"
                                   @bind="_searchSubject"
                                   placeholder="Enter meeting title to search for..."
                                   disabled="@_isLoading">
                            <div class="form-text">
                                Searching from @_startDate.ToString("yyyy-MM-dd") to @DateTime.Now.ToString("yyyy-MM-dd")
                            </div>
                        </div>

                        <button class="btn btn-primary" @onclick="SearchMeetingsAsync" disabled="@(_isLoading || string.IsNullOrWhiteSpace(_searchSubject))">
                            @if (_isLoading)
                            {
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                <text> Searching...</text>
                            }
                            else
                            {
                                <i class="bi bi-search"></i>
                                <text> Search Meetings</text>
                            }
                        </button>
                    </Authorized>
                    <NotAuthorized>
                        <p class="text-muted">Please sign in to search your calendar.</p>
                        <a href="authentication/login" class="btn btn-primary">
                            <i class="bi bi-box-arrow-in-right"></i> Sign In with Microsoft
                        </a>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
        </div>
    }
    else
    {
        <div class="card mb-4">
            <div class="card-header">
                <h5>Step 2: Upload JSON File</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Upload a JSON file generated by your Power Automate flow.
                    <a href="/docs/power-automate-guide.md" target="_blank">View setup guide</a>
                </div>

                <div class="mb-3">
                    <label for="fileInput" class="form-label">Select JSON File</label>
                    <InputFile id="fileInput" OnChange="HandleFileSelected" class="form-control" accept=".json" disabled="@_isLoading" />
                    <div class="form-text">Maximum file size: 10 MB</div>
                </div>

                @if (_fileSelected)
                {
                    <div class="mb-3">
                        <label for="subjectFilterInput" class="form-label">Meeting Subject Filter</label>
                        <input type="text" class="form-control" id="subjectFilterInput"
                               @bind="_searchSubject"
                               placeholder="Enter meeting title to filter..."
                               disabled="@_isLoading">
                        <div class="form-text">Only events containing this text will be included</div>
                    </div>

                    <button class="btn btn-primary" @onclick="ProcessJsonFileAsync" disabled="@(_isLoading || string.IsNullOrWhiteSpace(_searchSubject))">
                        @if (_isLoading)
                        {
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                            <text> Processing...</text>
                        }
                        else
                        {
                            <i class="bi bi-gear"></i>
                            <text> Process File</text>
                        }
                    </button>
                }
            </div>
        </div>
    }

    @if (_monthlyResults != null && _monthlyResults.Any())
    {
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Monthly Breakdown</h5>
                <button class="btn btn-success btn-sm" @onclick="ExportToExcelAsync">
                    <i class="bi bi-file-earmark-excel"></i> Export to Excel
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Month</th>
                                <th>Year</th>
                                <th class="text-end">Total Days</th>
                                <th class="text-end">Weekdays</th>
                                <th class="text-end">Weekends</th>
                                <th class="text-end">Holidays</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var month in _monthlyResults)
                            {
                                <tr>
                                    <td>@month.MonthName</td>
                                    <td>@month.Year</td>
                                    <td class="text-end"><strong>@month.TotalMeetingDays</strong></td>
                                    <td class="text-end">@month.WeekdayCount</td>
                                    <td class="text-end">@month.WeekendCount</td>
                                    <td class="text-end">@month.HolidayCount</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th colspan="2">Total</th>
                                <th class="text-end">@_monthlyResults.Sum(m => m.TotalMeetingDays)</th>
                                <th class="text-end">@_monthlyResults.Sum(m => m.WeekdayCount)</th>
                                <th class="text-end">@_monthlyResults.Sum(m => m.WeekendCount)</th>
                                <th class="text-end">@_monthlyResults.Sum(m => m.HolidayCount)</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="mt-3 text-muted">
                    <small>
                        <i class="bi bi-info-circle"></i>
                        Showing results for meetings with subject containing "<strong>@_searchSubject</strong>"
                    </small>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private enum DataSourceMode
    {
        GraphApi,
        JsonImport
    }

    private DataSourceMode _selectedMode = DataSourceMode.JsonImport; // Default to JSON import since Graph API not fully implemented
    private string _searchSubject = string.Empty;
    private List<MonthlyBreakdown>? _monthlyResults;
    private bool _isLoading = false;
    private string? _errorMessage;
    private string? _successMessage;
    private DateTime _startDate = DateTime.Now.AddYears(-1);
    private bool _fileSelected = false;
    private string? _jsonContent;

    private void SelectMode(DataSourceMode mode)
    {
        _selectedMode = mode;
        _monthlyResults = null;
        _searchSubject = string.Empty;
        _fileSelected = false;
        _jsonContent = null;
        ClearMessages();
    }

    private void ClearError() => _errorMessage = null;
    private void ClearSuccess() => _successMessage = null;
    private void ClearMessages()
    {
        _errorMessage = null;
        _successMessage = null;
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        ClearMessages();
        _fileSelected = false;
        _jsonContent = null;

        var file = e.File;

        if (file.Size > 10 * 1024 * 1024) // 10 MB limit
        {
            _errorMessage = "File exceeds 10MB size limit.";
            return;
        }

        if (!file.Name.EndsWith(".json", StringComparison.OrdinalIgnoreCase))
        {
            _errorMessage = "Please select a JSON file.";
            return;
        }

        try
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var reader = new System.IO.StreamReader(stream);
            _jsonContent = await reader.ReadToEndAsync();
            _fileSelected = true;
            _successMessage = $"File '{file.Name}' loaded successfully. Enter a subject filter and click Process.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error reading file: {ex.Message}";
        }
    }

    private async Task ProcessJsonFileAsync()
    {
        ClearMessages();
        _isLoading = true;
        _monthlyResults = null;

        try
        {
            if (string.IsNullOrWhiteSpace(_jsonContent))
            {
                _errorMessage = "No file content to process.";
                return;
            }

            // Parse JSON and get events
            var events = await JsonImportService.ParseJsonFileAsync(
                _jsonContent,
                _searchSubject,
                _startDate,
                DateTime.Now);

            if (!events.Any())
            {
                _errorMessage = $"No events found matching subject '{_searchSubject}' in the uploaded file.";
                return;
            }

            // Analyze meetings
            _monthlyResults = MeetingAnalysisService.AnalyzeMeetings(events);

            if (!_monthlyResults.Any())
            {
                _errorMessage = "No meeting days found after analysis.";
                return;
            }

            _successMessage = $"Successfully analyzed {events.Count} events across {_monthlyResults.Sum(m => m.TotalMeetingDays)} unique days.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error processing JSON file: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SearchMeetingsAsync()
    {
        ClearMessages();
        _isLoading = true;
        _monthlyResults = null;

        try
        {
            // TODO: Implement Graph API integration when GraphService is fully configured
            _errorMessage = "Graph API integration is not yet complete. Please use JSON Import mode for now.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error searching meetings: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ExportToExcelAsync()
    {
        if (_monthlyResults == null || !_monthlyResults.Any())
        {
            _errorMessage = "No data to export.";
            return;
        }

        try
        {
            var excelData = ExcelExportService.GenerateExcelReport(_monthlyResults, _searchSubject);
            var fileName = $"meeting_days_{_searchSubject.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";

            // Use JS interop to trigger download
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, Convert.ToBase64String(excelData));

            _successMessage = "Excel file downloaded successfully!";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error exporting to Excel: {ex.Message}";
        }
    }
}
