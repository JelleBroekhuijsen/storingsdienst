@page "/"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@inject IMeetingAnalysisService MeetingAnalysisService
@inject IExcelExportService ExcelExportService
@inject JsonImportService JsonImportService
@inject ICalendarDataService CalendarDataService
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar

<PageTitle>Meeting Days Tracker</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    <MudText Typo="Typo.h4" Class="mb-2">M365 Meeting Days Tracker</MudText>
    <MudText Typo="Typo.subtitle1" Class="mb-4 mud-text-secondary">
        Track and analyze meeting occurrences from your Microsoft 365 calendar.
        Choose between direct integration or JSON file import.
    </MudText>

    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-3">Step 1: Select Data Source</MudText>
        <MudToggleGroup T="DataSourceMode" @bind-Value="_selectedMode" Color="Color.Primary"
                        SelectionMode="SelectionMode.SingleSelection" CheckMark="true">
            <MudToggleItem Value="DataSourceMode.GraphApi">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Custom.Brands.Microsoft" />
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body1">Microsoft Graph API</MudText>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">
                            Requires Azure AD app registration
                        </MudText>
                    </MudStack>
                </MudStack>
            </MudToggleItem>
            <MudToggleItem Value="DataSourceMode.JsonImport">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.UploadFile" />
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body1">JSON File Upload</MudText>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">
                            Generated by Power Automate
                        </MudText>
                    </MudStack>
                </MudStack>
            </MudToggleItem>
        </MudToggleGroup>
    </MudPaper>

    @if (_selectedMode == DataSourceMode.GraphApi)
    {
        <MudPaper Class="pa-4 mb-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">Step 2: Search Meetings (Graph API)</MudText>

            <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
                <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" Size="Size.Small" />
                This mode requires authentication with your Microsoft 365 account.
                Users from any organization can sign in and consent to read their calendar.
            </MudAlert>

            <AuthorizeView>
                <Authorized>
                    <MudTextField T="string" @bind-Value="_searchSubject" Label="Meeting Subject"
                                  Placeholder="Enter meeting title to search for..."
                                  Variant="Variant.Outlined" Class="mb-3"
                                  Disabled="_isLoading"
                                  HelperText="@($"Searching from {_startDate:yyyy-MM-dd} to {DateTime.Now:yyyy-MM-dd}")" />

                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               OnClick="SearchMeetingsAsync"
                               Disabled="@(_isLoading || string.IsNullOrWhiteSpace(_searchSubject))"
                               StartIcon="@(_isLoading ? null : Icons.Material.Filled.Search)">
                        @if (_isLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Searching...</span>
                        }
                        else
                        {
                            <span>Search Meetings</span>
                        }
                    </MudButton>
                </Authorized>
                <NotAuthorized>
                    <MudText Typo="Typo.body1" Class="mud-text-secondary mb-3">
                        Please sign in to search your calendar.
                    </MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="authentication/login"
                               StartIcon="@Icons.Material.Filled.Login">
                        Sign In with Microsoft
                    </MudButton>
                </NotAuthorized>
            </AuthorizeView>
        </MudPaper>
    }
    else
    {
        <MudPaper Class="pa-4 mb-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">Step 2: Upload JSON File</MudText>

            <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
                <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" Size="Size.Small" />
                Upload a JSON file generated by your Power Automate flow.
                <MudLink Href="/guide/power-automate" Class="ml-1">View setup guide</MudLink>
            </MudAlert>

            <MudFileUpload T="IBrowserFile" Accept=".json" FilesChanged="HandleFileSelected"
                           MaximumFileCount="1" Class="mb-3" Disabled="_isLoading">
                <ActivatorContent>
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.CloudUpload">
                        Select JSON File
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>
            <MudText Typo="Typo.caption" Class="mud-text-secondary mb-3">
                Maximum file size: 10 MB
            </MudText>

            @if (_fileSelected)
            {
                <MudTextField T="string" @bind-Value="_searchSubject" Label="Meeting Subject Filter"
                              Placeholder="Enter meeting title to filter..."
                              Variant="Variant.Outlined" Class="mb-3"
                              Disabled="_isLoading"
                              HelperText="Only events containing this text will be included" />

                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                           OnClick="ProcessJsonFileAsync"
                           Disabled="@(_isLoading || string.IsNullOrWhiteSpace(_searchSubject))"
                           StartIcon="@(_isLoading ? null : Icons.Material.Filled.Settings)">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Processing...</span>
                    }
                    else
                    {
                        <span>Process File</span>
                    }
                </MudButton>
            }
        </MudPaper>
    }

    @if (_monthlyResults != null && _monthlyResults.Any())
    {
        <MudPaper Class="mb-4" Elevation="2">
            <MudTable Items="@_monthlyResults" Hover="true" Striped="true" Dense="true">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Monthly Breakdown</MudText>
                    <MudSpacer />
                    <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.GridOn"
                               OnClick="ExportToExcelAsync">
                        Export to Excel
                    </MudButton>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>Month</MudTh>
                    <MudTh>Year</MudTh>
                    <MudTh Style="text-align:right">Total Days</MudTh>
                    <MudTh Style="text-align:right">Weekdays</MudTh>
                    <MudTh Style="text-align:right">Saturdays</MudTh>
                    <MudTh Style="text-align:right">Sundays</MudTh>
                    <MudTh Style="text-align:right">Holidays</MudTh>
                    <MudTh>Holiday Details</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Month">@context.MonthName</MudTd>
                    <MudTd DataLabel="Year">@context.Year</MudTd>
                    <MudTd DataLabel="Total" Style="text-align:right">
                        <MudText Typo="Typo.body2"><b>@context.TotalMeetingDays</b></MudText>
                    </MudTd>
                    <MudTd DataLabel="Weekdays" Style="text-align:right">@context.WeekdayCount</MudTd>
                    <MudTd DataLabel="Saturdays" Style="text-align:right">@context.SaturdayCount</MudTd>
                    <MudTd DataLabel="Sundays" Style="text-align:right">@context.SundayCount</MudTd>
                    <MudTd DataLabel="Holidays" Style="text-align:right">@context.HolidayCount</MudTd>
                    <MudTd DataLabel="Holiday Details">
                        @if (context.HolidayNames.Any())
                        {
                            <MudText Typo="Typo.body2">@string.Join(", ", context.HolidayNames)</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">-</MudText>
                        }
                    </MudTd>
                </RowTemplate>
                <FooterContent>
                    <MudTh colspan="2"><strong>Total</strong></MudTh>
                    <MudTh Style="text-align:right"><strong>@_monthlyResults.Sum(m => m.TotalMeetingDays)</strong></MudTh>
                    <MudTh Style="text-align:right">@_monthlyResults.Sum(m => m.WeekdayCount)</MudTh>
                    <MudTh Style="text-align:right">@_monthlyResults.Sum(m => m.SaturdayCount)</MudTh>
                    <MudTh Style="text-align:right">@_monthlyResults.Sum(m => m.SundayCount)</MudTh>
                    <MudTh Style="text-align:right">@_monthlyResults.Sum(m => m.HolidayCount)</MudTh>
                    <MudTh></MudTh>
                </FooterContent>
            </MudTable>
            <MudCardContent>
                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                    Showing results for meetings with subject containing "<strong>@_searchSubject</strong>"
                </MudText>
            </MudCardContent>
        </MudPaper>

        <MudPaper Class="pa-4 mb-4" Elevation="2">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
                <MudText Typo="Typo.h6">Verify Paystub Data</MudText>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.AddCircle"
                           OnClick="AddVerificationComponent">
                    Add Another Month
                </MudButton>
            </MudStack>

            <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
                <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" Size="Size.Small" />
                Verify that your paystub data matches the calendar data.
                You can add multiple verification cards to check different months simultaneously.
            </MudAlert>

            @foreach (var verificationId in _verificationComponentIds)
            {
                <PaystubVerification
                    MonthlyResults="_monthlyResults"
                    Id="@verificationId"
                    AllowRemove="@(_verificationComponentIds.Count > 1)"
                    OnRemoveClicked="@(() => RemoveVerificationComponent(verificationId))" />
            }
        </MudPaper>
    }
</MudContainer>

@code {
    private enum DataSourceMode
    {
        GraphApi,
        JsonImport
    }

    private DataSourceMode _selectedMode = DataSourceMode.GraphApi;
    private string _searchSubject = string.Empty;
    private List<MonthlyBreakdown>? _monthlyResults;
    private bool _isLoading = false;
    private DateTime _startDate = DateTime.Now.AddYears(-1);
    private bool _fileSelected = false;
    private string? _jsonContent;
    private List<string> _verificationComponentIds = new List<string> { Guid.NewGuid().ToString() };

    private void AddVerificationComponent()
    {
        _verificationComponentIds.Add(Guid.NewGuid().ToString());
    }

    private void RemoveVerificationComponent(string id)
    {
        if (_verificationComponentIds.Count > 1)
        {
            _verificationComponentIds.Remove(id);
        }
    }

    private async Task HandleFileSelected(IBrowserFile? file)
    {
        _fileSelected = false;
        _jsonContent = null;

        if (file == null)
        {
            return;
        }

        if (file.Size > 10 * 1024 * 1024) // 10 MB limit
        {
            Snackbar.Add("File exceeds 10MB size limit.", Severity.Error);
            return;
        }

        if (!file.Name.EndsWith(".json", StringComparison.OrdinalIgnoreCase))
        {
            Snackbar.Add("Please select a JSON file.", Severity.Error);
            return;
        }

        try
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var reader = new System.IO.StreamReader(stream);
            _jsonContent = await reader.ReadToEndAsync();
            _fileSelected = true;
            Snackbar.Add($"File '{file.Name}' loaded successfully. Enter a subject filter and click Process.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error reading file: {ex.Message}", Severity.Error);
        }
    }

    private async Task ProcessJsonFileAsync()
    {
        _isLoading = true;
        _monthlyResults = null;

        try
        {
            if (string.IsNullOrWhiteSpace(_jsonContent))
            {
                Snackbar.Add("No file content to process.", Severity.Error);
                return;
            }

            // Parse JSON and get events
            var events = await JsonImportService.ParseJsonFileAsync(
                _jsonContent,
                _searchSubject,
                _startDate,
                DateTime.Now);

            if (!events.Any())
            {
                Snackbar.Add($"No events found matching subject '{_searchSubject}' in the uploaded file.", Severity.Warning);
                return;
            }

            // Analyze meetings
            _monthlyResults = MeetingAnalysisService.AnalyzeMeetings(events);

            if (!_monthlyResults.Any())
            {
                Snackbar.Add("No meeting days found after analysis.", Severity.Warning);
                return;
            }

            Snackbar.Add($"Successfully analyzed {events.Count} events across {_monthlyResults.Sum(m => m.TotalMeetingDays)} unique days.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error processing JSON file: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SearchMeetingsAsync()
    {
        _isLoading = true;
        _monthlyResults = null;

        try
        {
            // Call Graph API to fetch calendar events
            var events = await CalendarDataService.GetMeetingsBySubjectAsync(
                _searchSubject,
                _startDate,
                DateTime.Now);

            if (!events.Any())
            {
                Snackbar.Add($"No events found matching subject '{_searchSubject}' in your calendar.", Severity.Warning);
                return;
            }

            // Analyze the meetings
            _monthlyResults = MeetingAnalysisService.AnalyzeMeetings(events);

            if (!_monthlyResults.Any())
            {
                Snackbar.Add("No meeting days found after analysis.", Severity.Warning);
                return;
            }

            Snackbar.Add($"Successfully found {events.Count} events across {_monthlyResults.Sum(m => m.TotalMeetingDays)} unique days.", Severity.Success);
        }
        catch (AccessTokenNotAvailableException ex)
        {
            // Token expired or not available - redirect to login
            ex.Redirect();
        }
        catch (UnauthorizedAccessException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (InvalidOperationException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error searching meetings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ExportToExcelAsync()
    {
        if (_monthlyResults == null || !_monthlyResults.Any())
        {
            Snackbar.Add("No data to export.", Severity.Error);
            return;
        }

        try
        {
            var excelData = ExcelExportService.GenerateExcelReport(_monthlyResults, _searchSubject);
            var fileName = $"meeting_days_{_searchSubject.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";

            // Use JS interop to trigger download
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, Convert.ToBase64String(excelData));

            Snackbar.Add("Excel file downloaded successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting to Excel: {ex.Message}", Severity.Error);
        }
    }
}
