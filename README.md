# Storingsdienst - M365 Calendar Meeting Tracker

A Blazor WebAssembly application for tracking and analyzing Microsoft 365 calendar meetings with monthly breakdowns and Excel export capabilities.

## Features

- **Dual Data Source Support**:
  - **Graph API Mode**: Direct OAuth authentication and real-time M365 calendar access
  - **JSON Import Mode**: Upload Power Automate-generated JSON files (no Microsoft Entra app registration required)
- **Meeting Analysis**: Tracks meetings up to 1 year in the past
- **Multi-Day Event Support**: Each day of multi-day events is counted separately
- **Dutch Holiday Detection**: Categorizes days as weekdays, weekends, or Dutch holidays
- **Monthly Breakdown**: Generates detailed monthly statistics
- **Excel Export**: Download results as formatted Excel spreadsheets

## Technology Stack

- **Frontend**: Blazor WebAssembly (ASP.NET Core 8.0)
- **Authentication**: Microsoft Authentication Library (MSAL)
- **API Integration**: Microsoft Graph API v1.0
- **Excel Export**: ClosedXML
- **Holiday Detection**: Custom Dutch holiday calculator with Easter algorithm
- **Deployment**: Azure Web App

## Project Structure

```
storingsdienst/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Storingsdienst.Client/           # Blazor WebAssembly client
â”‚   â”‚   â”œâ”€â”€ Services/                    # Business logic services
â”‚   â”‚   â”œâ”€â”€ Models/                      # Data models
â”‚   â”‚   â”œâ”€â”€ Components/                  # Razor components
â”‚   â”‚   â”œâ”€â”€ Pages/                       # Razor pages
â”‚   â”‚   â””â”€â”€ wwwroot/                     # Static files & docs
â”‚   â””â”€â”€ Storingsdienst/                  # ASP.NET Core host
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ Storingsdienst.Client.Tests/    # Unit tests
â””â”€â”€ storingsdienst.sln
```

## Getting Started

### Prerequisites

- .NET 8.0 SDK
- Visual Studio 2022 or VS Code with C# extension
- Microsoft 365 account (for Graph API mode)
- Azure subscription (for app registration - Graph API mode only)

### Installation

1. Clone the repository:
   ```bash
   git clone <repository-url>
   cd storingsdienst
   ```

2. Restore dependencies:
   ```bash
   dotnet restore
   ```

3. **For Graph API Mode** (optional):
   - Register an application in Azure Portal (Microsoft Entra â†’ App registrations)
   - Add redirect URI: `https://localhost:7xxx/authentication/login-callback`
   - Add API permissions: `User.Read`, `Calendars.Read`
   - Copy the Application (client) ID
   - Configure your Client ID (see [Configuration Guide](docs/CONFIGURATION.md) for details):
     - **Option 1** (Recommended): Create `appsettings.Development.json` with your Client ID
     - **Option 2**: Update `appsettings.json` locally (don't commit this change)

4. Run the application:
   ```bash
   cd src/Storingsdienst/Storingsdienst
   dotnet run
   ```

5. Open browser to the URL shown in the console (e.g., `http://localhost:5266`)

## Usage

### Graph API Mode (In Progress)

**Note**: Full Graph API integration is currently in progress. For now, please use JSON Import Mode.

1. Click "Microsoft Graph API" mode
2. Sign in with your M365 account
3. Enter the meeting subject to filter
4. Click "Search Meetings"
5. View monthly breakdown
6. Export to Excel

### JSON Import Mode (Fully Functional)

1. Click "JSON File Upload" mode (default)
2. Click "Select JSON File"
3. Choose a JSON file generated by Power Automate (see [Power Automate Guide](src/Storingsdienst/Storingsdienst.Client/wwwroot/docs/power-automate-guide.md))
   - Or use the sample file at `src/Storingsdienst/Storingsdienst.Client/wwwroot/sample-calendar-export.json` for testing
4. Enter the meeting subject to filter (e.g., "Project Standup")
5. Click "Process File"
6. View the monthly breakdown table showing:
   - Total meeting days per month
   - Weekdays, weekends, and holidays breakdown
7. Click "Export to Excel" to download the results

## Core Services

### HolidayService
Detects Dutch public holidays using the Meeus/Jones/Butcher Easter calculation algorithm. Includes:
- Fixed holidays (New Year, King's Day, Christmas)
- Calculated holidays (Easter, Ascension, Whitsun)
- Liberation Day (May 5)

### MeetingAnalysisService
Analyzes calendar events and generates monthly breakdowns:
- Expands multi-day events into individual days
- Categorizes days (weekday/weekend/holiday)
- Groups by month with counts

### ExcelExportService
Generates Excel reports using ClosedXML with:
- Title and metadata
- Monthly breakdown table
- Formatted headers
- Auto-fitted columns

### JsonImportService
Parses Power Automate JSON exports:
- Validates JSON schema
- Maps to internal DTOs
- Client-side filtering
- Date range validation

### GraphService
Integrates with Microsoft Graph API:
- OAuth authentication
- Calendar view queries
- Pagination support
- Error handling

## Configuration

### Environment-Based Configuration

The application uses environment-based configuration to keep sensitive values out of version control:

- **`appsettings.json`**: Base configuration with placeholders (committed to Git)
- **`appsettings.Development.json`**: Local development overrides (not committed)
- **GitHub Secrets**: Production values injected during deployment

**For detailed setup instructions**, see [Configuration Guide](docs/CONFIGURATION.md).

### appsettings.json (Base Configuration)

```json
{
  "AzureAd": {
    "Authority": "https://login.microsoftonline.com/common",
    "ClientId": "YOUR_AZURE_AD_CLIENT_ID_HERE",
    "ValidateAuthority": true
  },
  "MicrosoftGraph": {
    "BaseUrl": "https://graph.microsoft.com/v1.0",
    "Scopes": ["User.Read", "Calendars.Read"]
  }
}
```

## Development Status

âœ… **Completed**:
- Project structure and scaffolding
- All data models (CalendarEventDto, MonthlyBreakdown, PowerAutomateJsonSchema, etc.)
- Core services:
  - HolidayService (Dutch holiday detection with Easter algorithm)
  - MeetingAnalysisService (multi-day event expansion, categorization)
  - ExcelExportService (ClosedXML-based report generation)
  - JsonImportService (Power Automate JSON parsing)
  - GraphService structure (ready for full MSAL integration)
- UI Components:
  - Home.razor (main page with dual-mode interface)
  - Authentication.razor (MSAL callback handler)
  - NavMenu.razor (responsive navigation with auth state)
- JavaScript interop for Excel downloads
- File upload with validation (10MB limit, .json only)
- Error handling and user feedback
- Sample JSON test file
- Power Automate guide documentation
- MSAL authentication setup
- **JSON Import Mode fully functional**
- Solution builds and runs successfully

ðŸ”¨ **In Progress**:
- Full Graph API MSAL token provider integration
- Testing Graph API mode with real M365 account

ðŸ“‹ **Planned**:
- Integration tests
- Performance optimization
- Accessibility improvements

## Testing

### Unit Tests âœ…

The project includes comprehensive unit tests with **80%+ code coverage** target:

#### Test Coverage
- **HolidayService**: 11 test methods, 70+ test cases covering Dutch holidays, Easter algorithm, and caching
- **MeetingAnalysisService**: 17 test methods covering event analysis, day categorization, and multi-day events
- **ExcelExportService**: 15 test methods covering Excel generation, formatting, and edge cases
- **JsonImportService**: 20 test methods covering JSON parsing, filtering, validation, and error handling

#### Running Tests Locally

**Quick Start (Recommended)**:
```powershell
# Run tests with coverage report
.\run-tests-with-coverage.ps1

# Open HTML report automatically
.\run-tests-with-coverage.ps1 -OpenReport

# Custom coverage threshold
.\run-tests-with-coverage.ps1 -CoverageThreshold 85
```

**Using dotnet CLI**:
```bash
# Run tests only
dotnet test

# Run tests with coverage
dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura /p:Threshold=80
```

**Using Visual Studio**:
1. Open Test Explorer (Test â†’ Test Explorer)
2. Click "Run All Tests"
3. For coverage: Analyze â†’ Code Coverage â†’ All Tests

#### CI/CD Integration

Tests run automatically on every push to `main`:
- âœ… All tests must pass
- âœ… Minimum 80% line coverage required
- âœ… Coverage report published as artifact
- âœ… Test results displayed in workflow summary

For detailed testing documentation, see [tests/README.md](tests/README.md).

### Manual Testing (JSON Import Mode)

1. Start the application: `dotnet run --project src/Storingsdienst/Storingsdienst`
2. Open browser to the displayed URL (e.g., http://localhost:5266)
3. Use the sample JSON file at `src/Storingsdienst/Storingsdienst.Client/wwwroot/sample-calendar-export.json`
4. Upload the file and enter "Project Standup" as the filter
5. Verify the monthly breakdown shows correct categorization
6. Test Excel export functionality

## Deployment

![Deployment Status](https://github.com/<your-username>/storingsdienst/actions/workflows/deploy.yml/badge.svg)

The application is deployed to Azure Web App with a fully automated CI/CD pipeline using GitHub Actions and Bicep.

### Live Application
**Production URLs**: 
- **Custom Domain**: [https://storingsdienst.jll.io](https://storingsdienst.jll.io)
- **Azure Default**: [https://app-storingsdienst-prod.azurewebsites.net](https://app-storingsdienst-prod.azurewebsites.net)

For custom domain setup instructions, see [Custom Domain Configuration Guide](docs/CUSTOM_DOMAIN.md).

### Deployment Architecture

```
GitHub Repository (main branch)
    â†“
GitHub Actions Workflow
    â†“
    â”œâ”€ Build .NET 8 Application
    â”œâ”€ Inject Microsoft Entra Client ID
    â”œâ”€ Publish WebAssembly + Server
    â””â”€ Deploy to Azure Web App
        â†“
Azure App Service (West Europe)
    â”œâ”€ App Service Plan (B1 SKU, Windows)
    â”œâ”€ Web App (app-storingsdienst-prod)
    â””â”€ Application Insights (Monitoring)
```

### Infrastructure as Code
The entire Azure infrastructure is defined using Bicep templates:
- **Location**: `infra/main.bicep`
- **Environment**: Production (West Europe)
- **Cost**: ~â‚¬15-18/month

### Automated CI/CD Pipeline

#### Continuous Deployment
Every push to the `main` branch automatically triggers deployment:
```bash
git commit -m "Your changes"
git push origin main
# Application deploys automatically within 4-6 minutes
```

#### Manual Deployment
Go to **Actions** â†’ **Deploy Application** â†’ **Run workflow**

### Deployment Documentation
For complete deployment setup and configuration:
- **[Deployment Guide](docs/DEPLOYMENT.md)** - Complete setup instructions
- **[Custom Domain Guide](docs/CUSTOM_DOMAIN.md)** - Custom domain configuration
- **[Configuration Guide](docs/CONFIGURATION.md)** - Microsoft Entra and app settings
- **[Infrastructure README](infra/README.md)** - Bicep templates and Azure resources

### Key Features
- âœ… Fully automated CI/CD with GitHub Actions
- âœ… Infrastructure as Code using Bicep
- âœ… Separate deployment and application identities
- âœ… Multi-tenant Microsoft Entra authentication
- âœ… Application Insights monitoring
- âœ… HTTPS enforced
- âœ… Automatic rollback support

## Contributing

This is a private project for jll.io Consultancy.

## License

Proprietary - All rights reserved

## Support

For issues or questions, contact the development team via the issue tracker.
